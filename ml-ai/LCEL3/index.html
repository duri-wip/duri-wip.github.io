<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCEL (LangChain Expression Language) 3</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/study.css">
    <link rel="stylesheet" href="/assets/css/sidebar.css">
    <link rel="stylesheet" href="/assets/css/header.css">
    <link rel="stylesheet" href="/assets/css/banner.css">
    <link rel="stylesheet" href="/assets/css/sections.css">
    <link rel="stylesheet" href="/assets/css/post.css">
    <link rel="stylesheet" href="/assets/css/categories.css">
    <link rel="stylesheet" href="/assets/css/projects.css">
</head>
<body>
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar">
    <img src="/assets/images/avatar.png" alt="Duri" class="profile-image">
    <div class="profile-info">
        <h2>Duri</h2>
        <p>Ë—ËË‹ â‹†ï½¡ğ–¦¹ Ëš ğ“‡¼ Ëšï½¡â‹† â€Ë–Â°</p>
        <p>ì˜›ë‚ ì— 
 ë°ì´í„° ì—”ì§€ë‹ˆì–´ê°€ ìˆì—‡ìŠ¨.. ë°±ì—”ë“œ ì„œë²„ë„ ë§Œë“¤ê³  ì¸í”„ë¼ë„ êµ¬ì¶•í•˜ê³  ë°ì´í„° ë¶„ì„ë„ í–ˆìŠ¨.. </p>
    </div>
    
    <div class="contact-links">
        <div class="profile-divider">
    â €â €â €â €â €â €â¢€â¡¤â£¤â£€â €â €â €â €â €â €â €â €â €â €â£€â¡€â €â €â €â €â €â €
    â €â €â €â €â €â¢€â¡â €â €â ˆâ ³â£„â €â €â €â €â €â£€â ´â ‹â ‰â ‰â¡†â €â €â €â €â €
    â €â €â €â €â €â¢¸â €â €â €â €â €â ˆâ ‰â ‰â ™â “â šâ â €â €â €â €â£¿â €â €â €â €â €
    â €â €â €â €â¢€â â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ¹â£„â €â €â €â €
    â €â €â €â €â¡â €â €â €â €â €â ¶â €â €â €â €â €â €â ¦â €â €â €â €â €â ¸â¡†â €â €â €
    â¢ â£¤â£¶â£¾â£§â£¤â£¤â£€â¡€â €â €â €â €â ˆâ €â €â €â¢€â¡¤â ´â ¶â ¤â¢¤â¡€â£§â£€â£€â €
    â »â ¶â£¾â â €â €â €â €â ™â£†â €â €â €â €â €â €â£°â ‹â €â €â €â €â €â¢¹â£¿â£­â£½â ‡
    â €â €â ™â ¤â ´â¢¤â¡¤â ¤â ¤â ‹â ‰â ‰â ‰â ‰â ‰â ‰â ‰â ³â –â ¦â ¤â ¶â ¦â â â €â €â €
        </div>
        
        <a href="https://github.com/duri-wip" class="contact-link" target="_blank">
            <i class="fab fa-github"></i>
            <span>GitHub</span>
        </a>
        
        
        <a href="mailto:8s.eow.ooc@gmail.com" class="contact-link">
            <i class="fas fa-envelope"></i>
            <span>Email</span>
        </a>
        
    </div>
    
</aside>
        
        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <!-- í—¤ë” -->
            <header class="header">
    <nav>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/">home</a>
            </li>
            <li class="nav-item">
                <a href="/categories">category</a>
            </li>
            <li class="nav-item">
                <a href="/study">study</a>
            </li>
            <li class="nav-item">
                <a href="/projects">project</a>
            </li>
        </ul>
    </nav>
</header>
            
            <!-- ì½˜í…ì¸  ì˜ì—­ -->
            <div class="content">
                <article class="post">
    <header class="post-header">
        <h1 class="post-title">LCEL (LangChain Expression Language) 3</h1>
        <div class="post-meta">
            <time class="post-date">2025ë…„ 07ì›” 28ì¼</time>
            
            <div class="post-categories">
                
                    
                    <span class="category-tag">ML-AI</span>
                    
                
                    
                
                
                <span class="subcategory-tag">llm</span>
                
            </div>
            
            
            <div class="post-tags">
                
                <span class="tag">#genai-llm</span>
                
                <span class="tag">#langchain</span>
                
                <span class="tag">#lcel</span>
                
                <span class="tag">#runnable</span>
                
                <span class="tag">#chain</span>
                
                <span class="tag">#study-llm-framework</span>
                
            </div>
            
        </div>
    </header>

    <div class="post-content">
        <h2 id="chat-history-ê´€ë¦¬">Chat History ê´€ë¦¬</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_community.chat_message_histories</span> <span class="kn">import</span> <span class="n">SQLChatMessageHistory</span>

<span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">human_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">chat_message_history</span> <span class="o">=</span> <span class="nc">SQLChatMessageHistory</span><span class="p">(</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span><span class="p">,</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sqlite:///sqlite.db</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">chat_message_history</span><span class="p">.</span><span class="nf">get_messages</span><span class="p">()</span>

    <span class="n">ai_message</span> <span class="o">=</span> <span class="n">chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">chat_history</span><span class="sh">"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">human_message</span><span class="sh">"</span><span class="p">:</span> <span class="n">human_message</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="n">chat_message_history</span><span class="p">.</span><span class="nf">add_user_message</span><span class="p">(</span><span class="n">human_message</span><span class="p">)</span>
    <span class="n">chat_message_history</span><span class="p">.</span><span class="nf">add_ai_message</span><span class="p">(</span><span class="n">ai_message</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ai_message</span>

<span class="c1"># í˜¸ì¶œ
</span><span class="kn">from</span> <span class="n">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="n">session_id</span> <span class="o">=</span> <span class="nf">uuid4</span><span class="p">().</span><span class="nb">hex</span>
<span class="n">output1</span> <span class="o">=</span> <span class="nf">respond</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span> <span class="n">human_message</span><span class="o">=</span><span class="sh">"</span><span class="s">ì•ˆë…•í•˜ì„¸ìš”. ì œ ì´ë¦„ì€ ë‚˜ë­‡ìì…ë‹ˆë‹¤.</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">output1</span><span class="p">)</span>

<span class="n">output2</span> <span class="o">=</span> <span class="nf">respond</span><span class="p">(</span><span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span> <span class="n">human_message</span><span class="o">=</span><span class="sh">"</span><span class="s">ë‚´ ì´ë¦„ì´ ë­˜ê¹Œ?</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">output2</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="ì§€ì›í•˜ëŠ”-ë°ì´í„°ë² ì´ìŠ¤">ì§€ì›í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤</h2>

<p>SQLite ë§ê³  ë‹¤ë¥¸ ë°ì´í„°ë² ì´ìŠ¤ì˜ í†µí•©ë„ ì œê³µí•©ë‹ˆë‹¤:</p>

<ul>
  <li>ì¸ë©”ëª¨ë¦¬</li>
  <li>SQLAlchemyê°€ ì§€ì›í•˜ëŠ” ê°ì¢… ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤</li>
  <li>Redis</li>
  <li>DynamoDB</li>
  <li>CosmosDB</li>
  <li>Momento
ë“±</li>
</ul>

<h2 id="ë©”ëª¨ë¦¬">ë©”ëª¨ë¦¬</h2>

<p>ëŒ€í™” ì´ë ¥ì— ëŒ€í•œ ê³ ê¸‰ ì²˜ë¦¬ë¥¼ êµ¬í˜„í•˜ê³  ì‹¶ì€ ê²½ìš° ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ìµœê·¼ kê°œì˜ ëŒ€í™” ì´ë ¥ë§Œ í¬í•¨í•˜ê³  ì‹¶ì€ ê²½ìš°.
ConversationBufferWindowMemoryë‚˜ ConversationSummaryMemoryë¥¼ í•´ë‹¹ ì»´í¬ë„ŒíŠ¸ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<h2 id="langserve">LangServe</h2>

<p>LangChainì˜ ëŸ¬ë„ˆë¸”ì„ ê°„í¸í•˜ê²Œ REST APIë¡œ ë§Œë“¤ê¸° ìœ„í•œ íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤.</p>

<h2 id="-ì¶”ê°€ë¡œ-ì•Œì•„ë³¼-ë‚´ìš©">ğŸ“š ì¶”ê°€ë¡œ ì•Œì•„ë³¼ ë‚´ìš©</h2>

<h3 id="1-ê³ ê¸‰-runnable-íŒ¨í„´ë“¤">1. ê³ ê¸‰ Runnable íŒ¨í„´ë“¤</h3>

<p><strong>RunnableGenerator (ìŠ¤íŠ¸ë¦¬ë° ìƒì„±ê¸°):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_core.runnables</span> <span class="kn">import</span> <span class="n">RunnableGenerator</span>

<span class="k">def</span> <span class="nf">streaming_splitter</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="nb">buffer</span> <span class="o">=</span> <span class="sh">""</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
        <span class="nb">buffer</span> <span class="o">+=</span> <span class="n">chunk</span>
        <span class="c1"># ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ì—¬ yield
</span>        <span class="k">while</span> <span class="sh">'</span><span class="s">. </span><span class="sh">'</span> <span class="ow">in</span> <span class="nb">buffer</span><span class="p">:</span>
            <span class="n">sentence</span><span class="p">,</span> <span class="nb">buffer</span> <span class="o">=</span> <span class="nb">buffer</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">. </span><span class="sh">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">sentence</span> <span class="o">+</span> <span class="sh">'</span><span class="s">. </span><span class="sh">'</span>

    <span class="k">if</span> <span class="nb">buffer</span><span class="p">:</span>
        <span class="k">yield</span> <span class="nb">buffer</span>

<span class="n">streaming_chain</span> <span class="o">=</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">RunnableGenerator</span><span class="p">(</span><span class="n">streaming_splitter</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>RunnableRetry (ì¬ì‹œë„ ë¡œì§):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_core.runnables</span> <span class="kn">import</span> <span class="n">RunnableRetry</span>

<span class="n">retry_chain</span> <span class="o">=</span> <span class="nc">RunnableRetry</span><span class="p">(</span>
    <span class="n">bound</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">max_attempt_number</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">wait_exponential_jitter</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">stop_after_delay</span><span class="o">=</span><span class="mi">30</span>
<span class="p">)</span>
</code></pre></div></div>

<p><strong>RunnableWithMessageHistory (ëŒ€í™” ì´ë ¥ ê´€ë¦¬):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_core.runnables.history</span> <span class="kn">import</span> <span class="n">RunnableWithMessageHistory</span>
<span class="kn">from</span> <span class="n">langchain_community.chat_message_histories</span> <span class="kn">import</span> <span class="n">SQLChatMessageHistory</span>

<span class="k">def</span> <span class="nf">get_session_history</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="nc">SQLChatMessageHistory</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">sqlite:///memory.db</span><span class="sh">"</span><span class="p">)</span>

<span class="n">chain_with_history</span> <span class="o">=</span> <span class="nc">RunnableWithMessageHistory</span><span class="p">(</span>
    <span class="n">chain</span><span class="p">,</span>
    <span class="n">get_session_history</span><span class="p">,</span>
    <span class="n">input_messages_key</span><span class="o">=</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">history_messages_key</span><span class="o">=</span><span class="sh">"</span><span class="s">chat_history</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="2-ë³µì¡í•œ-ë¼ìš°íŒ…-ì „ëµ">2. ë³µì¡í•œ ë¼ìš°íŒ… ì „ëµ</h3>

<p><strong>Multi-Modal Routing:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="k">class</span> <span class="nc">RouteInput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">data_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">image</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">text</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">route_by_type</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span> <span class="n">RouteInput</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">input</span><span class="p">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">image</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vision_chain</span>
    <span class="k">elif</span> <span class="nb">input</span><span class="p">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">code_analysis_chain</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">general_chain</span>

<span class="n">routing_chain</span> <span class="o">=</span> <span class="nc">RunnableLambda</span><span class="p">(</span><span class="n">route_by_type</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Semantic Routing:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_community.utils.math</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>

<span class="k">def</span> <span class="nf">semantic_router</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">route_embeddings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">.</span><span class="nf">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">similarities</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">route</span><span class="p">,</span> <span class="n">embedding</span> <span class="ow">in</span> <span class="n">route_embeddings</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="nf">cosine_similarity</span><span class="p">([</span><span class="n">query_embedding</span><span class="p">],</span> <span class="p">[</span><span class="n">embedding</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">similarities</span><span class="p">[</span><span class="n">route</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span>

    <span class="n">best_route</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">similarities</span><span class="p">.</span><span class="n">get</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">route_chains</span><span class="p">[</span><span class="n">best_route</span><span class="p">]</span>

</code></pre></div></div>

    </div>

    <footer class="post-footer">
        <div class="post-nav">
            
            <a class="prev-post" href="/ml-ai/LCEL2/">
                <span class="nav-label">ì´ì „ ê¸€</span>
                <span class="nav-title">LCEL (LangChain Expression ...</span>
            </a>
            
            
            
            <a class="next-post" href="/ml-ai/RAG/">
                <span class="nav-label">ë‹¤ìŒ ê¸€</span>
                <span class="nav-title">RAG (Retrieval-Augmented Ge...</span>
            </a>
            
        </div>
        
        <div class="back-to-home">
            <a href="/">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </footer>
</article>
            </div>
        </main>
    </div>
</body>
</html>