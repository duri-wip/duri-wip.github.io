<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Ж│аЖИЅ ЖИ░в▓Ћ ВЎёВаё ВаЋв│х</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/study.css">
    <link rel="stylesheet" href="/assets/css/sidebar.css">
    <link rel="stylesheet" href="/assets/css/header.css">
    <link rel="stylesheet" href="/assets/css/banner.css">
    <link rel="stylesheet" href="/assets/css/sections.css">
    <link rel="stylesheet" href="/assets/css/post.css">
    <link rel="stylesheet" href="/assets/css/categories.css">
    <link rel="stylesheet" href="/assets/css/projects.css">
</head>
<body>
    <div class="container">
        <!-- ВѓгВЮ┤вЊюв░ћ -->
        <aside class="sidebar">
    <img src="/assets/images/avatar.png" alt="Duri" class="profile-image">
    <div class="profile-info">
        <h2>Duri</h2>
        <p>╦Ќ╦Ј╦І РІє№йА­ќд╣ ╦џ ­ЊЄ╝ ╦џ№йАРІє РЮђ╦ќ┬░</p>
        <p>ВўЏвѓаВЌљ 
 вЇ░ВЮ┤ьё░ ВЌћВДђвІѕВќ┤Ж░ђ ВъѕВЌЄВіе.. в░▒ВЌћвЊю Вёюв▓ёвЈё вДївЊцЖ│а ВЮИьћёвЮ╝вЈё ЖхгВХЋьЋўЖ│а вЇ░ВЮ┤ьё░ вХёВёЮвЈё ьќѕВіе.. </p>
    </div>
    
    <div class="contact-links">
        <div class="profile-divider">
    РађРађРађРађРађРађРбђРАцРБцРБђРађРађРађРађРађРађРађРађРађРађРБђРАђРађРађРађРађРађРађ
    РађРађРађРађРађРбђРАЈРађРађРаѕРа│РБёРађРађРађРађРађРБђРа┤РаІРаЅРаЅРАєРађРађРађРађРађ
    РађРађРађРађРађРбИРађРађРађРађРађРаѕРаЅРаЅРаЎРаЊРаџРаЂРађРађРађРађРБ┐РађРађРађРађРађ
    РађРађРађРађРбђРаъРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРа╣РБёРађРађРађРађ
    РађРађРађРађРАъРађРађРађРађРађРаХРађРађРађРађРађРађРадРађРађРађРађРађРаИРАєРађРађРађ
    РбаРБцРБХРБЙРБДРБцРБцРБђРАђРађРађРађРађРаѕРађРађРађРбђРАцРа┤РаХРацРбцРАђРБДРБђРБђРађ
    Ра╗РаХРБЙРаЂРађРађРађРађРаЎРБєРађРађРађРађРађРађРБ░РаІРађРађРађРађРађРб╣РБ┐РБГРБйРаЄ
    РађРађРаЎРацРа┤РбцРАцРацРацРаІРаЅРаЅРаЅРаЅРаЅРаЅРаЅРа│РаќРадРацРаХРадРаъРаЂРађРађРађ
        </div>
        
        <a href="https://github.com/duri-wip" class="contact-link" target="_blank">
            <i class="fab fa-github"></i>
            <span>GitHub</span>
        </a>
        
        
        <a href="mailto:8s.eow.ooc@gmail.com" class="contact-link">
            <i class="fas fa-envelope"></i>
            <span>Email</span>
        </a>
        
    </div>
    
</aside>
        
        <!-- вЕћВЮИ ВйўьЁљВИа -->
        <main class="main-content">
            <!-- ьЌцвЇћ -->
            <header class="header">
    <nav>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/">home</a>
            </li>
            <li class="nav-item">
                <a href="/categories">category</a>
            </li>
            <li class="nav-item">
                <a href="/study">study</a>
            </li>
            <li class="nav-item">
                <a href="/projects">project</a>
            </li>
        </ul>
    </nav>
</header>
            
            <!-- ВйўьЁљВИа ВўЂВЌГ -->
            <div class="content">
                <article class="post">
    <header class="post-header">
        <h1 class="post-title">RAG Ж│аЖИЅ ЖИ░в▓Ћ ВЎёВаё ВаЋв│х</h1>
        <div class="post-meta">
            <time class="post-date">2025вЁё 08ВЏћ 04ВЮ╝</time>
            
            <div class="post-categories">
                
                    
                    <span class="category-tag">ML-AI</span>
                    
                
                    
                
                
                <span class="subcategory-tag">rag</span>
                
            </div>
            
            
            <div class="post-tags">
                
                <span class="tag">#genai-llm</span>
                
                <span class="tag">#langchain</span>
                
                <span class="tag">#rag</span>
                
                <span class="tag">#hyde</span>
                
                <span class="tag">#rerank</span>
                
                <span class="tag">#hybrid-search</span>
                
                <span class="tag">#study-llm-framework</span>
                
            </div>
            
        </div>
    </header>

    <div class="post-content">
        <h1 id="ragВЌљ-Ж┤ђьЋю-вІцВќЉьЋю-Ж│аЖИЅ-ЖИ░в▓Ћ">RAGВЌљ Ж┤ђьЋю вІцВќЉьЋю Ж│аЖИЅ ЖИ░в▓Ћ</h1>

<h2 id="1-Ж▓ђВЃЅ-В┐╝вдг-Ж┤ђвае-ЖИ░в▓Ћ">1. Ж▓ђВЃЅ В┐╝вдг Ж┤ђвае ЖИ░в▓Ћ</h2>

<h3 id="hyde-hypothetical-document-embeddings">HyDE (Hypothetical Document Embeddings)</h3>

<ul>
  <li><strong>Ж░ювЁљ</strong>: ВДѕВЮўВЌљ вїђьЋю Ж░ђВЃЂВЮў вІхв│ђ(В╗еьЁЇВіцьіИ ВЌєВЮ┤) ВЃЮВё▒ Рєњ ВЮ┤ вІхв│ђЖ│╝ ВюаВѓгьЋю вгИВёю Ж▓ђВЃЅ В┐╝вдг ВЃЮВё▒</li>
  <li><strong>вфЕВаЂ</strong>: Ж▓ђВЃЅ В┐╝вдгВЮў ьњѕВДѕ ьќЦВЃЂ</li>
</ul>

<h4 id="1-ВДЂВаЉ-Жхгьўё">1. ВДЂВаЉ Жхгьўё</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hypothetical_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
    вІцВЮї ВДѕвгИВЌљ ьЋю вгИВъЦВю╝вАю вІхьЋўВёИВџћ.
    ВДѕвгИ : {question}
    </span><span class="sh">"""</span><span class="p">)</span>

<span class="n">hypothetical_chain</span> <span class="o">=</span> <span class="n">hypothetical_prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>

<span class="n">hyde_rag_chain</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">hypothetical_chain</span> <span class="o">|</span> <span class="n">retriever</span><span class="p">,</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>

<span class="n">hyde_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainВЮў Ж░юВџћвЦ╝ ВЋївацВцў</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="2-langchain-вфевЊѕ-ьЎюВџЕ">2. LangChain вфевЊѕ ьЎюВџЕ</h4>

<ul>
  <li><strong>HypotheticalDocumentEmbedder</strong> ВѓгВџЕ</li>
</ul>

<h3 id="multi-query-generation">Multi-Query Generation</h3>

<ul>
  <li><strong>Ж░ювЁљ</strong>: в│хВѕў Ж▓ђВЃЅ В┐╝вдг ВЃЮВё▒Вю╝вАю вІцВќЉьЋю Ж┤ђВаљВЌљВёю Ж▓ђВЃЅ</li>
</ul>

<h4 id="1-ВДЂВаЉ-Жхгьўё-1">1. ВДЂВаЉ Жхгьўё</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span> <span class="nc">QueryGenerate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">queries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Ж▓ђВЃЅ В┐╝вдг вфЕвАЮ</span><span class="sh">"</span><span class="p">)</span>

<span class="n">query_generate_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="se">\
</span><span class="s">    ВДѕвгИВЌљ вїђьЋ┤ в▓Аьё░ вЇ░ВЮ┤ьё░в▓аВЮ┤ВіцВЌљВёю Ж┤ђвае вгИВёювЦ╝ Ж▓ђВЃЅьЋўЖИ░ ВюёьЋю 3Ж░юВЮў ВёювАю вІцвЦИ Ж▓ђВЃЅ В┐╝вдгвЦ╝ ВЃЮВё▒ьЋўВёИВџћ.
    Ж▒░вдг ЖИ░в░ў ВюаВѓгВё▒ Ж▓ђВЃЅВЮў ьЋюЖ│ёвЦ╝ Жи╣в│хьЋўЖИ░ ВюёьЋ┤ ВѓгВџЕВъљВЮў ВДѕвгИВЌљ вїђьЋ┤ ВЌгвЪг Ж┤ђВаљВЮё ВаюЖ│хьЋўвіћ Ж▓ЃВЮ┤ вфЕьЉюВъЁвІѕвІц.

    ВДѕвгИ : {question}
    </span><span class="sh">"""</span><span class="p">)</span>

<span class="n">query_generate_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">query_generate_prompt</span>
    <span class="o">|</span> <span class="n">model</span><span class="p">.</span><span class="nf">with_structured_output</span><span class="p">(</span><span class="n">QueryGenerate</span><span class="p">)</span>
    <span class="o">|</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="n">queries</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">multi_query_chain</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">query_generate_chain</span> <span class="o">|</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">map</span><span class="p">(),</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>

<span class="n">multi_query_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainВЮў Ж░юВџћвЦ╝ ВЋївацВцў</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Note</strong>: <code class="language-plaintext highlighter-rouge">map</code>ВЮђ LangChain вЪгвёѕвИћВЮ┤ ВаюЖ│хьЋўвіћ вЕћВёювЊю ВцЉ ьЋўвѓўвАю, ВЏљвъў вЪгвёѕвИћВЮў ВЮИВъљВЎђ в░ўьЎўЖ░њВЮё вдгВіцьіИьЎћьЋўвіћ вЕћВёювЊюВъЁвІѕвІц.</p>

<h4 id="2-langchain-вфевЊѕ-ьЎюВџЕ-1">2. LangChain вфевЊѕ ьЎюВџЕ</h4>

<ul>
  <li><strong>MultiQueryRetriever</strong> ВѓгВџЕ</li>
</ul>

<h2 id="2-Ж▓ђВЃЅ-ьЏё-ЖИ░в▓Ћ-reciprocal-rank-fusion-rrf">2. Ж▓ђВЃЅ ьЏё ЖИ░в▓Ћ: Reciprocal Rank Fusion (RRF)</h2>

<p>ВЌгвЪг Ж▓ђВЃЅ Ж▓░Ж│╝ВЮў ВѕюВюёвЦ╝ ВюхьЋЕьЋ┤ ВаЋвагьЋўвіћ ЖИ░в▓ЋВъЁвІѕвІц.</p>

<h3 id="rag-fusion">RAG-Fusion</h3>

<ul>
  <li><strong>Ж░ювЁљ</strong>: ВЌгвЪг Ж▓ђВЃЅ В┐╝вдгвЦ╝ ВЃЮВё▒ьЋўЖ│а ВЮ┤вЦ╝ Ж▓░Ж│╝вЦ╝ ВаЋвагьЋўЖИ░</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_core.documents</span> <span class="kn">import</span> <span class="n">Document</span>

<span class="k">def</span> <span class="nf">reciprocal_rank_fusion</span><span class="p">(</span>
        <span class="n">retriever_outputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># Ж░Ђ вгИВёюВЮў ВйўьЁљВИа(вгИВъљВЌ┤)ВЎђ ЖиИ ВаљВѕўВЮў вДцьЋЉВЮё ВађВъЦьЋўвіћ вћЋВЁћвёѕвдг Вцђв╣ё
</span>    <span class="n">content_score_mapping</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Ж▓ђВЃЅ В┐╝вдгвДѕвІц в░ўв│х
</span>    <span class="k">for</span> <span class="n">docs</span> <span class="ow">in</span> <span class="n">retriever_outputs</span><span class="p">:</span>
        <span class="c1"># Ж▓ђВЃЅ Ж▓░Ж│╝ВЮў вгИВёювДѕвІц в░ўв│х
</span>        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">docs</span><span class="p">):</span>
            <span class="c1"># вгИВёюВЮў ВйўьЁљВИаВЎђ ВаљВѕўвЦ╝ вћЋВЁћвёѕвдгВЌљ ВХћЖ░ђ
</span>            <span class="n">content</span> <span class="o">=</span> <span class="n">doc</span><span class="p">.</span><span class="n">page_content</span>

            <span class="k">if</span> <span class="n">content</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content_score_mapping</span><span class="p">:</span>
                <span class="n">content_score_mapping</span><span class="p">[</span><span class="n">content</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># ВаљВѕў ВЌЁвЇ░ВЮ┤ьіИ
</span>            <span class="n">content_score_mapping</span><span class="p">[</span><span class="n">content</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

    <span class="c1"># ВаљВѕўВЌљ вћ░вЮ╝ ВаЋвагвљю вгИВёю вфЕвАЮ в░ўьЎў
</span>    <span class="n">sorted_contents</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span>
        <span class="n">content_score_mapping</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">content</span> <span class="k">for</span> <span class="n">content</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sorted_contents</span><span class="p">]</span>

<span class="c1"># В▓┤ВЮИ Жхгьўё
</span><span class="n">rag_fusion_chain</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">query_generate_chain</span> <span class="o">|</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">map</span><span class="p">()</span> <span class="o">|</span> <span class="n">reciprocal_rank_fusion</span><span class="p">,</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>

<span class="n">rag_fusion_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainВЮў Ж░юВџћвЦ╝ ВЋївацВцў</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="rerank">ReRank</h3>

<ul>
  <li><strong>Ж░ювЁљ</strong>: Вќ┤вќц Ж▓ђВЃЅ В┐╝вдгВЌљ вїђьЋю ВЌгвЪг Ж▓ђВЃЅ Ж▓░Ж│╝вЦ╝ ВаЋвагьЋўЖИ░</li>
  <li><strong>ВъЦВаљ</strong>: вдгвъГьЂгВџЕ веИВІавЪгвІЮ вфевЇИВЮё ВѓгВџЕьЋ┤Вёю Ж▓ђВЃЅ Ж▓░Ж│╝вЦ╝ ВаЋваг. Въёв▓авћЕ в▓Аьё░ВЮў ВюаВѓгвЈё Ж▓ђВЃЅв│┤вІц Ж│ёВѓ░в╣ёВџЕВЮ┤ вєњВЮђ вїђВІа въГьѓ╣ ВаЋьЎЋвЈёЖ░ђ вєњВЮї</li>
</ul>

<h4 id="1-cohere-вфевЇИ-ВѓгВџЕ">1. Cohere вфевЇИ ВѓгВџЕ</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">langchain_cohere</span> <span class="kn">import</span> <span class="n">CohereRerank</span>
<span class="kn">from</span> <span class="n">langchain_core.documents</span> <span class="kn">import</span> <span class="n">Document</span>

<span class="k">def</span> <span class="nf">rerank</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="sh">"</span><span class="s">documents</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">cohere_reranker</span> <span class="o">=</span> <span class="nc">CohereRerank</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">rerank-multilingual-v3.0</span><span class="sh">"</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="n">top_n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cohere_reranker</span><span class="p">.</span><span class="nf">compress_documents</span><span class="p">(</span><span class="n">documents</span><span class="o">=</span><span class="n">documents</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>

<span class="n">rerank_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
        <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">retriever</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="o">|</span> <span class="n">RunnablePassthrough</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">rerank</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">prompt</span>
    <span class="o">|</span> <span class="n">model</span>
    <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">rerank_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainВЮў Ж░юВџћвЦ╝ ВЋївацВцў</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Note</strong>: RunnablePassthrough assignВЮё ьєхьЋ┤ {question, context}ВЮў ВХюваЦВЮ┤ rerankьЋеВѕўВЮў ВЮИВъљ inpВЌљ ВаёвІгвљЕвІѕвІц.</p>

<h4 id="2-langchain-вфевЊѕ-ьЎюВџЕ-2">2. LangChain вфевЊѕ ьЎюВџЕ</h4>

<ul>
  <li><strong>ContextualCompressionRetriever</strong> ВѓгВџЕ</li>
</ul>

<h2 id="3-в│хВѕўВЮў-вдгьіИвдгв▓ёвЦ╝-ВѓгВџЕьЋўвіћ-ЖИ░в▓Ћ">3. в│хВѕўВЮў вдгьіИвдгв▓ёвЦ╝ ВѓгВџЕьЋўвіћ ЖИ░в▓Ћ</h2>

<h3 id="вЮ╝Вџ░ьіИВЌљ-вћ░вЮ╝-вІцвЦИ-вдгьіИвдгв▓ё-ВѓгВџЕьЋўЖИ░">вЮ╝Вџ░ьіИВЌљ вћ░вЮ╝ вІцвЦИ вдгьіИвдгв▓ё ВѓгВџЕьЋўЖИ░</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_community.retrievers</span> <span class="kn">import</span> <span class="n">TavilySearchAPIRetriever</span>

<span class="c1"># LangSmithВЌљВёю вЇћ Въў ьЎЋВЮИьЋўЖИ░ ВюёьЋю ВёцВаЋ
</span><span class="n">langchain_document_retriever</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">with_config</span><span class="p">({</span><span class="sh">"</span><span class="s">run_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">langchain_document_retriever</span><span class="sh">"</span><span class="p">})</span>
<span class="n">web_retriever</span> <span class="o">=</span> <span class="nc">TavilySearchAPIRetriever</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">).</span><span class="nf">with_config</span><span class="p">({</span><span class="sh">"</span><span class="s">run_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">web_retriever</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># ВѓгВџЕВъљ ВъЁваЦВЮё ЖИ░в░ўВю╝вАю LLMВЮ┤ вдгьіИвдгв▓ёвЦ╝ ВёаьЃЮьЋўвіћ В▓┤ВЮИ
</span><span class="kn">from</span> <span class="n">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">Route</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">langchain_document</span> <span class="o">=</span> <span class="sh">"</span><span class="s">langchain_document</span><span class="sh">"</span>
    <span class="n">web</span> <span class="o">=</span> <span class="sh">"</span><span class="s">web</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">RouteOutput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">route</span><span class="p">:</span> <span class="n">Route</span>

<span class="n">route_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
    вІцВЮї ВДѕвгИВЌљ вїђьЋ┤ ВаЂВаѕьЋю вдгьіИвдгв▓ёвЦ╝ ВёаьЃЮьЋўВёИВџћ.
    ВДѕвгИ : {question}
    </span><span class="sh">"""</span><span class="p">)</span>

<span class="n">route_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">route_prompt</span>
    <span class="o">|</span> <span class="n">model</span><span class="p">.</span><span class="nf">with_structured_output</span><span class="p">(</span><span class="n">RouteOutput</span><span class="p">)</span>
    <span class="o">|</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="n">route</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># вЮ╝Вџ░ьїЁ Ж▓░Ж│╝вЦ╝ Ж│авацьЋ┤ Ж▓ђВЃЅьЋўвіћ ьЋеВѕў Жхгьўё
</span><span class="k">def</span> <span class="nf">routed_retriever</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">route</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="sh">"</span><span class="s">route</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">route</span> <span class="o">==</span> <span class="n">Route</span><span class="p">.</span><span class="n">langchain_document</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">langchain_document_retriever</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">route</span> <span class="o">==</span> <span class="n">Route</span><span class="p">.</span><span class="n">web</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">web_retriever</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>

    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalid route: </span><span class="si">{</span><span class="n">route</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># вЮ╝Вџ░ьіИ В▓┤ВЮИЖ│╝ вЮ╝Вџ░ьіИ Ж▓░Ж│╝вЦ╝ Ж│авацьЋ┤ Ж▓ђВЃЅьЋўвіћ В▓┤ВЮИ
</span><span class="n">routed_retriever_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
        <span class="sh">"</span><span class="s">route</span><span class="sh">"</span><span class="p">:</span> <span class="n">route_chain</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="o">|</span> <span class="n">RunnablePassthrough</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">routed_retriever</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">prompt</span>
    <span class="o">|</span> <span class="n">model</span>
    <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">routed_retriever_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainВЮў Ж░юВџћвЦ╝ ВЋївацВцў</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="ьЋўВЮ┤вИївдгвЊю-Ж▓ђВЃЅ">ьЋўВЮ┤вИївдгвЊю Ж▓ђВЃЅ</h3>

<p>RAGВЮў ЖхгьўёВЌљВёювіћ Въёв▓авћЕ в▓Аьё░ВЮў ВюаВѓгвЈё Ж▓ђВЃЅВЮё ВѕўьќЅьЋўвіћвЇ░, в▓ћВџЕВаЂВю╝вАю вДївЊцВќ┤ВДё Въёв▓авћЕ вфевЇИВЌљВёювіћ ьЋЎВіхвЇ░ВЮ┤ьё░ВЌљ ьЈгьЋевљўВДђ ВЋіВЮђ Ж│аВюавфЁВѓгвѓў ВаёвгИВџЕВќ┤ВЮў ВюаВѓгвЈё Ж│ёВѓ░ВЮ┤ Вќ┤вахВіхвІѕвІц.</p>

<p>ВъљВЌ░Вќ┤ В▓ўвдгВЮў Ж│аВаёВаЂВЮИ ЖИ░в▓ЋВю╝вАю вІеВќ┤ВЮў вЊ▒ВъЦ в╣ѕвЈёвЦ╝ ЖИ░в░ўВю╝вАю ьЁЇВіцьіИВЮў ВюаВѓгвЈёвЦ╝ Ж│ёВѓ░ьЋўвіћ <strong>TF-IDF</strong>, <strong>BM25</strong>(TF-IDFВЮў Ж░юВёаьїљ) вЊ▒ВЮ┤ ВъѕВіхвІѕвІц.</p>

<p>ВЮ┤вЪ░ ВЋїЖ│авдгВдўВЮё ВѓгВџЕьЋўвЕ┤ Ж│хьєх вІеВќ┤ВЮў в╣ѕвЈёЖ░ђ вєњВю╝вЕ┤ в▓Аьё░ ВюаВѓгвЈёЖ░ђ вєњВЋёВДђЖИ░ вЋївгИВЌљ, в▓ћВџЕ Въёв▓авћЕ вфевЇИВЮў вІеВаљВЮё в│┤ВЎёьЋўЖИ░ ВЅйВіхвІѕвІц.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        сђї Въёв▓авћЕ вфевЇИВЌљ ВЮўьЋю в▓Аьё░ьЎћ                  -- в░ђВДЉв▓Аьё░(вїђвХђвХё ВџћВєїЖ░ђ 0ВЮ┤ ВЋёвІў)
TEXT ---
         сё┤ TF-IDF вўљвіћ BM25вЦ╝ ВѓгВџЕьЋю в▓Аьё░ьЎћ         -- ьЮгВєїв▓Аьё░(0ВЮ┤ вДјВЮї)
</code></pre></div></div>

<p>в▓Аьё░ ьЂ┤вЮ╝Вџ░вЊю Вёюв╣ёВіцВЮИ <strong>PINECONE</strong>ВЌљВёювЈё в░ђВДЉ в▓Аьё░ВЎђ ьЮгВєї в▓Аьё░ Ж▓ђВЃЅВЮё ВА░ьЋЕьЋю ьЋўВЮ┤вИївдгвЊю Ж▓ђВЃЅВЮё ВаюЖ│хьЋўЖ│а ВъѕВіхвІѕвІц.</p>

<h4 id="1-ьЋўВЮ┤вИївдгвЊю-Ж▓ђВЃЅ-Жхгьўё-bm25-ВѓгВџЕ">1. ьЋўВЮ┤вИївдгвЊю Ж▓ђВЃЅ Жхгьўё: BM25 ВѓгВџЕ</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>rank-bm25<span class="o">==</span>0.2.2
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_community.retrievers</span> <span class="kn">import</span> <span class="n">BM25Retriever</span>

<span class="n">chroma_retriever</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">with_config</span><span class="p">({</span><span class="sh">"</span><span class="s">run_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">chroma_retriever</span><span class="sh">"</span><span class="p">})</span>

<span class="n">bm25_retriever</span> <span class="o">=</span> <span class="n">BM25Retriever</span><span class="p">.</span><span class="nf">from_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">).</span><span class="nf">with_config</span><span class="p">({</span><span class="sh">"</span><span class="s">run_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bm25_retriever</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># вЉљ вдгьіИвдгв▓ёвЦ╝ ВА░ьЋЕьЋ┤ ьЋўВЮ┤вИївдгвЊю Ж▓ђВЃЅ В▓┤ВЮИ Жхгьўё
</span><span class="n">hybrid_retriever_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nc">RunnableParallel</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">chroma_documents</span><span class="sh">"</span><span class="p">:</span> <span class="n">chroma_retriever</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">bm25_documents</span><span class="sh">"</span><span class="p">:</span> <span class="n">bm25_retriever</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="o">|</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">chroma_documents</span><span class="sh">"</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">bm25_documents</span><span class="sh">"</span><span class="p">]])</span>
    <span class="o">|</span> <span class="n">reciprocal_rank_fusion</span>
<span class="p">)</span>

<span class="c1"># ВаёВ▓┤ RAG В▓┤ВЮИ Жхгьўё
</span><span class="n">rag_chain</span> <span class="o">=</span> <span class="p">({</span>
    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">hybrid_retriever_chain</span><span class="p">,</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">())</span>

<span class="n">rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainВЮў Ж░юВџћвЦ╝ ВЋївацВцў</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="2-langchain-вфевЊѕ-ьЎюВџЕ-3">2. LangChain вфевЊѕ ьЎюВџЕ</h4>

<ul>
  <li><strong>EnsembleRetriever</strong> ВѓгВџЕ</li>
</ul>

<h2 id="-ВХћЖ░ђвАю-ВЋїВЋёв│╝-вѓ┤ВџЕ">­ЪЊџ ВХћЖ░ђвАю ВЋїВЋёв│╝ вѓ┤ВџЕ</h2>

<h3 id="1-ВхюВІа-rag-ЖИ░в▓ЋвЊц">1. ВхюВІа RAG ЖИ░в▓ЋвЊц</h3>

<p><strong>Contextual Retrieval (В╗еьЁЇВіцьіИ в│┤Ж░Ћ Ж▓ђВЃЅ):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_core.prompts</span> <span class="kn">import</span> <span class="n">ChatPromptTemplate</span>

<span class="c1"># Ж░Ђ В▓ГьЂгВЌљ В╗еьЁЇВіцьіИ ВаЋв│┤ ВХћЖ░ђ
</span><span class="n">context_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
вІцВЮї вгИВёю В▓ГьЂгВЌљ вїђьЋ┤ ВаёВ▓┤ вгИВёюВЮў вДЦвЮйВЮё Ж│авацьЋўВЌг
Ж░ёвІеьЋю в░░Ж▓й ВёцвфЁВЮё ВХћЖ░ђьЋ┤ВБ╝ВёИВџћ.

ВаёВ▓┤ вгИВёю ВБ╝Ваю: {document_topic}
В▓ГьЂг вѓ┤ВџЕ: {chunk_content}

в░░Ж▓й ВёцвфЁВЮ┤ ьЈгьЋевљю В▓ГьЂг:
</span><span class="sh">"""</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_context_to_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">document_topic</span><span class="p">):</span>
    <span class="n">contextual_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="n">context_added</span> <span class="o">=</span> <span class="n">context_prompt</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
            <span class="n">document_topic</span><span class="o">=</span><span class="n">document_topic</span><span class="p">,</span>
            <span class="n">chunk_content</span><span class="o">=</span><span class="n">chunk</span><span class="p">.</span><span class="n">page_content</span>
        <span class="p">)</span>
        <span class="c1"># LLMВю╝вАю В╗еьЁЇВіцьіИ ВХћЖ░ђвљю В▓ГьЂг ВЃЮВё▒
</span>        <span class="n">enhanced_chunk</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">context_added</span><span class="p">)</span>
        <span class="n">contextual_chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">enhanced_chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">contextual_chunks</span>
</code></pre></div></div>

<p><strong>Parent Document Retriever (ВЃЂВюё вгИВёю Ж▓ђВЃЅ):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.retrievers</span> <span class="kn">import</span> <span class="n">ParentDocumentRetriever</span>
<span class="kn">from</span> <span class="n">langchain.storage</span> <span class="kn">import</span> <span class="n">InMemoryStore</span>

<span class="c1"># ВъЉВЮђ В▓ГьЂгвАю Ж▓ђВЃЅьЋўВДђвДї ьЂ░ В╗еьЁЇВіцьіИ в░ўьЎў
</span><span class="n">parent_splitter</span> <span class="o">=</span> <span class="nc">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
<span class="n">child_splitter</span> <span class="o">=</span> <span class="nc">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

<span class="n">store</span> <span class="o">=</span> <span class="nc">InMemoryStore</span><span class="p">()</span>

<span class="n">retriever</span> <span class="o">=</span> <span class="nc">ParentDocumentRetriever</span><span class="p">(</span>
    <span class="n">vectorstore</span><span class="o">=</span><span class="n">vectorstore</span><span class="p">,</span>
    <span class="n">docstore</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
    <span class="n">child_splitter</span><span class="o">=</span><span class="n">child_splitter</span><span class="p">,</span>
    <span class="n">parent_splitter</span><span class="o">=</span><span class="n">parent_splitter</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p><strong>Multi-Vector Retriever (вІцВцЉ в▓Аьё░ Ж▓ђВЃЅ):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.retrievers.multi_vector</span> <span class="kn">import</span> <span class="n">MultiVectorRetriever</span>

<span class="c1"># ьЋўвѓўВЮў вгИВёюВЌљ вїђьЋ┤ ВЌгвЪг ьЉюьўё в░ЕВІЮ ВЃЮВё▒
</span><span class="k">def</span> <span class="nf">create_multi_representations</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">summary</span><span class="sh">"</span><span class="p">:</span> <span class="n">summarize_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">keywords</span><span class="sh">"</span><span class="p">:</span> <span class="n">keyword_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">questions</span><span class="sh">"</span><span class="p">:</span> <span class="n">question_gen_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">:</span> <span class="n">doc</span><span class="p">.</span><span class="n">page_content</span>
    <span class="p">}</span>

<span class="n">multi_retriever</span> <span class="o">=</span> <span class="nc">MultiVectorRetriever</span><span class="p">(</span>
    <span class="n">vectorstore</span><span class="o">=</span><span class="n">vectorstore</span><span class="p">,</span>
    <span class="n">docstore</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
    <span class="n">id_key</span><span class="o">=</span><span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="2-Ж│аЖИЅ-ьЈЅЖ░ђ-в░Ј-ВхюВаЂьЎћ">2. Ж│аЖИЅ ьЈЅЖ░ђ в░Ј ВхюВаЂьЎћ</h3>

<p><strong>A/B Testing for RAG:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RAGVariant</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">retriever</span><span class="p">:</span> <span class="nb">any</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">RAGExperiment</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">variants</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RAGVariant</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">variants</span> <span class="o">=</span> <span class="n">variants</span>
        <span class="n">self</span><span class="p">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">run_experiment</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">test_questions</span><span class="p">,</span> <span class="n">sample_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">test_questions</span><span class="p">:</span>
            <span class="c1"># въювЇцьЋўЖ▓ї variant ВёаьЃЮ
</span>            <span class="n">variant</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">variants</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">sample_ratio</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">evaluate_variant</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="n">question</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">variant</span><span class="sh">"</span><span class="p">:</span> <span class="n">variant</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">})</span>

    <span class="k">def</span> <span class="nf">evaluate_variant</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">variant</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
        <span class="c1"># ВІцВаю ьЈЅЖ░ђ вАюВДЂ
</span>        <span class="n">context</span> <span class="o">=</span> <span class="n">variant</span><span class="p">.</span><span class="n">retriever</span><span class="p">.</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">variant</span><span class="p">.</span><span class="n">prompt</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">answer</span><span class="sh">"</span><span class="p">:</span> <span class="n">answer</span><span class="p">,</span> <span class="sh">"</span><span class="s">context_count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">context</span><span class="p">)}</span>
</code></pre></div></div>

<p><strong>Dynamic Retrieval Optimization:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AdaptiveRetriever</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">retrievers</span><span class="p">,</span> <span class="n">performance_tracker</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">retrievers</span> <span class="o">=</span> <span class="n">retrievers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tracker</span> <span class="o">=</span> <span class="n">performance_tracker</span>
        <span class="n">self</span><span class="p">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">retrievers</span><span class="p">.</span><span class="nf">keys</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># Вё▒віЦ ЖИ░в░ўВю╝вАю retriever ВёаьЃЮ
</span>        <span class="n">best_retriever</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">select_best_retriever</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">retrievers</span><span class="p">[</span><span class="n">best_retriever</span><span class="p">].</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Ж▓░Ж│╝ ьњѕВДѕ ьћ╝вЊюв░▒ ВѕўВДЉ
</span>        <span class="n">self</span><span class="p">.</span><span class="n">tracker</span><span class="p">.</span><span class="nf">record_retrieval</span><span class="p">(</span><span class="n">best_retriever</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span>

    <span class="k">def</span> <span class="nf">select_best_retriever</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># В┐╝вдг ВюаьўЋ вХёВёЮьЋ┤Вёю ВхюВаЂ retriever ВёаьЃЮ
</span>        <span class="n">query_type</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">classify_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">retrievers</span><span class="p">.</span><span class="nf">keys</span><span class="p">(),</span>
                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_type_affinity</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">query_type</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="3-Ж│аЖИЅ-ьћёвАгьћёьіИ-ВЌћВДђвІѕВќ┤вДЂ">3. Ж│аЖИЅ ьћёвАгьћёьіИ ВЌћВДђвІѕВќ┤вДЂ</h3>

<p><strong>Self-RAG (ВъљЖИ░ в░ўВё▒ RAG):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self_rag_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
ВДѕвгИ: {question}
Ж▓ђВЃЅвљю ВаЋв│┤: {context}

1вІеЖ│ё: Ж▓ђВЃЅвљю ВаЋв│┤Ж░ђ ВДѕвгИВЌљ Ж┤ђваеВЮ┤ ВъѕвіћВДђ ьЈЅЖ░ђьЋўВёИВџћ.
Ж┤ђваеВё▒ ВаљВѕў: [1-10]

2вІеЖ│ё: Ж┤ђваеВё▒ВЮ┤ 7Ваљ ВЮ┤ВЃЂВЮ┤вЕ┤ вІхв│ђВЮё ВЃЮВё▒ьЋўЖ│а,
ЖиИваЄВДђ ВЋіВю╝вЕ┤ </span><span class="sh">"</span><span class="s">ВХћЖ░ђ ВаЋв│┤Ж░ђ ьЋёВџћьЋЕвІѕвІц</span><span class="sh">"</span><span class="s">вЮ╝Ж│а ВЮЉвІхьЋўВёИВџћ.

3вІеЖ│ё: ВЃЮВё▒ьЋю вІхв│ђВЮ┤ Ж▓ђВЃЅвљю ВаЋв│┤ВЌљ ЖИ░в░ўьЋўЖ│а ВъѕвіћВДђ ьЎЋВЮИьЋўВёИВџћ.
Жи╝Ж▒░: [Ж▓ђВЃЅ ВаЋв│┤ВЌљВёю ВЮИВџЕ]

ВхюВбЁ вІхв│ђ:
</span><span class="sh">"""</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">self_rag_chain</span><span class="p">(</span><span class="n">question</span><span class="p">):</span>
    <span class="c1"># 1В░е Ж▓ђВЃЅ
</span>    <span class="n">initial_docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>

    <span class="c1"># ВъљЖИ░ ьЈЅЖ░ђ
</span>    <span class="n">evaluation</span> <span class="o">=</span> <span class="n">self_rag_prompt</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="nf">format_docs</span><span class="p">(</span><span class="n">initial_docs</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="c1"># ВХћЖ░ђ Ж▓ђВЃЅ ьЋёВџћВІю
</span>    <span class="k">if</span> <span class="sh">"</span><span class="s">ВХћЖ░ђ ВаЋв│┤Ж░ђ ьЋёВџћьЋЕвІѕвІц</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">evaluation</span><span class="p">:</span>
        <span class="c1"># В┐╝вдг ьЎЋВъЦ вўљвіћ вІцвЦИ Ж▓ђВЃЅ Ваёвъх ВІювЈё
</span>        <span class="n">expanded_query</span> <span class="o">=</span> <span class="nf">expand_query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="n">additional_docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">expanded_query</span><span class="p">)</span>
        <span class="c1"># ВъгВІювЈё
</span>        <span class="k">return</span> <span class="n">self_rag_prompt</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="nf">format_docs</span><span class="p">(</span><span class="n">initial_docs</span> <span class="o">+</span> <span class="n">additional_docs</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">evaluation</span>
</code></pre></div></div>

<h3 id="4-Ж│аЖИЅ-Ж▓ђВЃЅ-ЖИ░в▓Ћ">4. Ж│аЖИЅ Ж▓ђВЃЅ ЖИ░в▓Ћ</h3>

<p><strong>Iterative Retrieval (в░ўв│х Ж▓ђВЃЅ):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">iterative_retrieval</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">all_docs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_question</span> <span class="o">=</span> <span class="n">question</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="c1"># ьўёВъг ВДѕвгИВю╝вАю Ж▓ђВЃЅ
</span>        <span class="n">docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">current_question</span><span class="p">)</span>
        <span class="n">all_docs</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>

        <span class="c1"># Ж▓ђВЃЅ Ж▓░Ж│╝вАю ьЏёВєЇ ВДѕвгИ ВЃЮВё▒
</span>        <span class="n">follow_up_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
        ВЏљв│И ВДѕвгИ: {original_question}
        Ж▓ђВЃЅ Ж▓░Ж│╝: {search_results}

        ВЮ┤ Ж▓ђВЃЅ Ж▓░Ж│╝вЦ╝ в░ћьЃЋВю╝вАю, ВЏљв│И ВДѕвгИВЌљ вЇћ ВЎёВаёьъѕ вІхьЋўЖИ░ ВюёьЋ┤
        ВХћЖ░ђвАю ьЋёВџћьЋю ВаЋв│┤вЦ╝ В░ЙЖИ░ ВюёьЋю Ж▓ђВЃЅ В┐╝вдгвЦ╝ ВЃЮВё▒ьЋўВёИВџћ.

        ВХћЖ░ђ Ж▓ђВЃЅ В┐╝вдг:
        </span><span class="sh">"""</span><span class="p">)</span>

        <span class="n">follow_up</span> <span class="o">=</span> <span class="n">follow_up_prompt</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">original_question</span><span class="sh">"</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">search_results</span><span class="sh">"</span><span class="p">:</span> <span class="nf">format_docs</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
        <span class="p">})</span>

        <span class="n">current_question</span> <span class="o">=</span> <span class="n">follow_up</span>

        <span class="c1"># ВХЕвХёьЋю ВаЋв│┤ ВѕўВДЉ ьЎЋВЮИ
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_sufficient_information</span><span class="p">(</span><span class="n">all_docs</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">all_docs</span>
</code></pre></div></div>

<h2 id="-ьЋЎВіхьЋўвЕ┤Вёю-ВЋїЖ▓ї-вљю-Ваљ">­ЪћЇ ьЋЎВіхьЋўвЕ┤Вёю ВЋїЖ▓ї вљю Ваљ</h2>

<h3 id="1-hydeВЮў-ВІцВаю-ьџеЖ│╝ВЎђ-ьЋюЖ│ё">1. HyDEВЮў ВІцВаю ьџеЖ│╝ВЎђ ьЋюЖ│ё</h3>

<p><strong>ьџеЖ│╝Ж░ђ ВбІВЮђ Ж▓йВџ░:</strong></p>

<ul>
  <li>ВаёвгИ вЈёвЕћВЮИ ВДѕвгИ (ВЮўвБї, в▓ЋвЦа, ЖИ░Вѕа)</li>
  <li>ВХћВЃЂВаЂ Ж░ювЁљВЌљ вїђьЋю ВДѕвгИ</li>
  <li>ВѓгВџЕВъљ ВДѕвгИВЮ┤ вфеьўИьЋю Ж▓йВџ░</li>
</ul>

<p><strong>ьџеЖ│╝Ж░ђ ВаюьЋюВаЂВЮИ Ж▓йВџ░:</strong></p>

<ul>
  <li>ВѓгВІц ьЎЋВЮИ ВДѕвгИ</li>
  <li>вДцВџ░ ЖхгВ▓┤ВаЂВЮИ вЇ░ВЮ┤ьё░ Ж▓ђВЃЅ</li>
  <li>ВІцВІюЖ░ё ВаЋв│┤Ж░ђ ьЋёВџћьЋю Ж▓йВџ░</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">should_use_hyde</span><span class="p">(</span><span class="n">question</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">HyDE ВѓгВџЕ ВЌгвХђ Ж▓░ВаЋ</span><span class="sh">"""</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ВХћВЃЂВаЂ</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">ВЏљвдг</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Ж░ювЁљ</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ВЮ┤Вюа</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">в░Ев▓Ћ</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">ВаёвгИВаЂ</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">ЖИ░Вѕа</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ВЮўвБї</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">в▓ЋвЦа</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ьЋЎВѕа</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">вХѕвфЁьЎЋ</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">?</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Вќ┤вќ╗Ж▓ї</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ВЎю</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ВёцвфЁ</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">keywords</span> <span class="ow">in</span> <span class="n">indicators</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">question</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">category</span>

    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">ЖхгВ▓┤ВаЂ_ВѓгВІц_ВДѕвгИ</span><span class="sh">"</span>
</code></pre></div></div>

<h3 id="2-вЕђьІ░-В┐╝вдгВЮў-ВхюВаЂ-Ж░юВѕў">2. вЕђьІ░ В┐╝вдгВЮў ВхюВаЂ Ж░юВѕў</h3>

<p>ВІцьЌў Ж▓░Ж│╝, <strong>3-5Ж░юВЮў В┐╝вдг</strong>Ж░ђ ВхюВаЂ:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">optimal_multi_query_count</span><span class="p">(</span><span class="n">question_complexity</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">question_complexity</span> <span class="o">==</span> <span class="sh">"</span><span class="s">simple</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># ВЏљв│И + 1Ж░ю в│ђьўЋ
</span>    <span class="k">elif</span> <span class="n">question_complexity</span> <span class="o">==</span> <span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>  <span class="c1"># ВЏљв│И + 2Ж░ю в│ђьўЋ
</span>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># complex
</span>        <span class="k">return</span> <span class="mi">5</span>  <span class="c1"># ВЏљв│И + 4Ж░ю в│ђьўЋ
</span></code></pre></div></div>

<h3 id="3-rrf-ьїївЮ╝в»Иьё░-kВЮў-ВІцВаю-ВўЂьќЦ">3. RRF ьїївЮ╝в»Иьё░ kВЮў ВІцВаю ВўЂьќЦ</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">analyze_rrf_k_impact</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">RRF k Ж░њВЮ┤ Ж▓░Ж│╝ВЌљ в»ИВ╣ўвіћ ВўЂьќЦ вХёВёЮ</span><span class="sh">"""</span>
    <span class="n">k_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ВЃЂВюёЖХї вгИВёю Ж░ђВцЉВ╣ў: </span><span class="si">{</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">k</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ьЋўВюёЖХї вгИВёю Ж░ђВцЉВ╣ў (rank=10): </span><span class="si">{</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">k</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Ж▓░Ж│╝:</strong></p>

<ul>
  <li>k=1: ВѕюВюё В░еВЮ┤ Жи╣вїђьЎћ (ВЃЂВюё вгИВёю ВЋЋвЈёВаЂ Вџ░Вюё)</li>
  <li>k=60: ЖиаьўЋВъАьъї Ж░ђВцЉВ╣ў (ЖИ░в│ИЖ░њ)</li>
  <li>k=100: ВѕюВюё В░еВЮ┤ ВхюВєїьЎћ (вфевЊа вгИВёю в╣ёВіиьЋю Ж░ђВцЉВ╣ў)</li>
</ul>

<h3 id="4-ьЋўВЮ┤вИївдгвЊю-Ж▓ђВЃЅВЮў-ВхюВаЂ-в╣ёВюе">4. ьЋўВЮ┤вИївдгвЊю Ж▓ђВЃЅВЮў ВхюВаЂ в╣ёВюе</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">find_optimal_hybrid_ratio</span><span class="p">(</span><span class="n">dense_retriever</span><span class="p">,</span> <span class="n">sparse_retriever</span><span class="p">,</span> <span class="n">test_queries</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">в░ђВДЉ/ьЮгВєї Ж▓ђВЃЅВЮў ВхюВаЂ Ж▓░ьЋЕ в╣ёВюе ьЃљВЃЅ</span><span class="sh">"""</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>  <span class="c1"># в░ђВДЉ в▓Аьё░ в╣ёВюе
</span>
    <span class="n">best_ratio</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">ratios</span><span class="p">:</span>
        <span class="c1"># Ж░Ђ в╣ёВюевАю ьЋўВЮ┤вИївдгвЊю Ж▓ђВЃЅ ВѕўьќЅ
</span>        <span class="n">hybrid_retriever</span> <span class="o">=</span> <span class="nc">EnsembleRetriever</span><span class="p">(</span>
            <span class="n">retrievers</span><span class="o">=</span><span class="p">[</span><span class="n">dense_retriever</span><span class="p">,</span> <span class="n">sparse_retriever</span><span class="p">],</span>
            <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">ratio</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">ratio</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># ьЈЅЖ░ђ ВаљВѕў Ж│ёВѓ░
</span>        <span class="n">score</span> <span class="o">=</span> <span class="nf">evaluate_retriever</span><span class="p">(</span><span class="n">hybrid_retriever</span><span class="p">,</span> <span class="n">test_queries</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
            <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">ratio</span>

    <span class="k">return</span> <span class="n">best_ratio</span>
</code></pre></div></div>

<p><strong>ВЮ╝в░ўВаЂВЮИ Ж▓йьЌўЖ░њ:</strong></p>

<ul>
  <li>ЖИ░Вѕа вгИВёю: в░ђВДЉ 70% + ьЮгВєї 30%</li>
  <li>вЅ┤Віц/ВЮ╝в░ў: в░ђВДЉ 50% + ьЮгВєї 50%</li>
  <li>FAQ: в░ђВДЉ 40% + ьЮгВєї 60%</li>
</ul>

<h3 id="5-rerank-вфевЇИВЮў-ВёаьЃЮ-ЖИ░Вцђ">5. ReRank вфевЇИВЮў ВёаьЃЮ ЖИ░Вцђ</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rerank_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">cohere-rerank-multilingual-v3.0</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ВќИВќ┤</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">вІцЖхГВќ┤ (ьЋюЖхГВќ┤ ьЈгьЋе)</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Вё▒віЦ</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">вєњВЮї</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">в╣ёВџЕ</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">вєњВЮї</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ВџЕвЈё</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ьћёвАювЇЋВЁў</span><span class="sh">"</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">bge-reranker-large</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ВќИВќ┤</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ВўЂВќ┤ ВцЉВІг</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Вё▒віЦ</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ВцЉЖ░ё</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">в╣ёВџЕ</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">вг┤вБї</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ВџЕвЈё</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ВІцьЌў/ьћёвАюьєаьЃђВъЁ</span><span class="sh">"</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">sentence-transformers/ms-marco-MiniLM-L-12-v2</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ВќИВќ┤</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ВўЂВќ┤</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Вё▒віЦ</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ВцЉЖ░ё</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">в╣ёВџЕ</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">вг┤вБї</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ВџЕвЈё</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">в╣авЦИ ьћёвАюьєаьЃђВъЁ</span><span class="sh">"</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="6-ВІцВаю-ьћёвАювЇЋВЁўВЌљВёюВЮў-Вё▒віЦ-ВхюВаЂьЎћ-Ж▓йьЌў">6. ВІцВаю ьћёвАювЇЋВЁўВЌљВёюВЮў Вё▒віЦ ВхюВаЂьЎћ Ж▓йьЌў</h3>

<p><strong>В▓Гьѓ╣ Ваёвъх ВхюВаЂьЎћ:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">adaptive_chunking</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">вгИВёю ВюаьўЋВЌљ вћ░вЦИ ВаЂВЮЉВаЂ В▓Гьѓ╣</span><span class="sh">"""</span>
    <span class="n">strategies</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="se">\n\n</span><span class="s">class </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n\n</span><span class="s">def </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">]},</span>
        <span class="sh">"</span><span class="s">legal</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span> <span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\</span><span class="s">n</span><span class="se">\\</span><span class="s">d+</span><span class="se">\\</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">. </span><span class="sh">"</span><span class="p">]},</span>
        <span class="sh">"</span><span class="s">technical</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="s">### </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="s">- </span><span class="sh">"</span><span class="p">]}</span>
    <span class="p">}</span>

    <span class="n">strategy</span> <span class="o">=</span> <span class="n">strategies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">. </span><span class="sh">"</span><span class="p">]})</span>

    <span class="n">splitter</span> <span class="o">=</span> <span class="nc">RecursiveCharacterTextSplitter</span><span class="p">(</span>
        <span class="n">chunk_size</span><span class="o">=</span><span class="n">strategy</span><span class="p">[</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">chunk_overlap</span><span class="o">=</span><span class="nf">int</span><span class="p">(</span><span class="n">strategy</span><span class="p">[</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span>  <span class="c1"># 10% Ж▓╣В╣е
</span>        <span class="n">separators</span><span class="o">=</span><span class="n">strategy</span><span class="p">[</span><span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">splitter</span><span class="p">.</span><span class="nf">split_documents</span><span class="p">([</span><span class="n">document</span><span class="p">])</span>
</code></pre></div></div>

<p><strong>в▓Аьё░ DB Вё▒віЦ ВхюВаЂьЎћ:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">optimize_vector_db</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">в▓Аьё░ DB Вё▒віЦ ВхюВаЂьЎћ ьїЂ</span><span class="sh">"""</span>
    <span class="n">tips</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ВЮИвЇ▒Віц_ЖхгВё▒</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">HNSW &gt; IVF &gt; Flat (Вё▒віЦ vs ВаЋьЎЋвЈё)</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">в░░В╣ў_ьЂгЖИ░</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Въёв▓авћЕВІю 100-1000Ж░ю вІеВюёвАю в░░В╣ў В▓ўвдг</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">вЕћвфевдг_Ж┤ђвдг</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ВБ╝ЖИ░ВаЂ ВЮИвЇ▒Віц ВЋЋВХЋ в░Ј ВаЋвдг</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">В┐╝вдг_ВхюВаЂьЎћ</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">top_kвіћ 20 ВЮ┤ьЋўвАю ВаюьЋю</span><span class="sh">"</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">tips</span>
</code></pre></div></div>

<p>ВЮ┤вЪгьЋю Ж│аЖИЅ ЖИ░в▓ЋвЊцЖ│╝ ВІцВаё Ж▓йьЌўВЮё ьєхьЋ┤ вЇћВџ▒ ьџеЖ│╝ВаЂВЮИ RAG ВІюВіцьЁюВЮё ЖхгВХЋьЋа Вѕў ВъѕВіхвІѕвІц.</p>

    </div>

    <footer class="post-footer">
        <div class="post-nav">
            
            <a class="prev-post" href="/ml-ai/evaluation/">
                <span class="nav-label">ВЮ┤Ваё ЖИђ</span>
                <span class="nav-title">RAG ВІюВіцьЁю ьЈЅЖ░ђьЋўЖИ░</span>
            </a>
            
            
            
            <a class="next-post" href="/ml-ai/prompt-engineering/">
                <span class="nav-label">вІцВЮї ЖИђ</span>
                <span class="nav-title">ьћёвАгьћёьіИ ВЌћВДђвІѕВќ┤вДЂ ВЎёВаё ВаЋв│х</span>
            </a>
            
        </div>
        
        <div class="back-to-home">
            <a href="/">Рєљ ьЎѕВю╝вАю вЈїВЋёЖ░ђЖИ░</a>
        </div>
    </footer>
</article>
            </div>
        </main>
    </div>
</body>
</html>