<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG ê³ ê¸‰ ê¸°ë²• ì™„ì „ ì •ë³µ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/study.css">
    <link rel="stylesheet" href="/assets/css/sidebar.css">
    <link rel="stylesheet" href="/assets/css/header.css">
    <link rel="stylesheet" href="/assets/css/banner.css">
    <link rel="stylesheet" href="/assets/css/sections.css">
    <link rel="stylesheet" href="/assets/css/post.css">
    <link rel="stylesheet" href="/assets/css/categories.css">
    <link rel="stylesheet" href="/assets/css/projects.css">
</head>
<body>
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar">
    <img src="/assets/images/avatar.png" alt="Duri" class="profile-image">
    <div class="profile-info">
        <h2>Duri</h2>
        <p>Ë—ËË‹ â‹†ï½¡ğ–¦¹ Ëš ğ“‡¼ Ëšï½¡â‹† â€Ë–Â°</p>
        <p>ì˜›ë‚ ì— 
 ë°ì´í„° ì—”ì§€ë‹ˆì–´ê°€ ìˆì—‡ìŠ¨.. ë°±ì—”ë“œ ì„œë²„ë„ ë§Œë“¤ê³  ì¸í”„ë¼ë„ êµ¬ì¶•í•˜ê³  ë°ì´í„° ë¶„ì„ë„ í–ˆìŠ¨.. </p>
    </div>
    
    <div class="contact-links">
        <div class="profile-divider">
    â €â €â €â €â €â €â¢€â¡¤â£¤â£€â €â €â €â €â €â €â €â €â €â €â£€â¡€â €â €â €â €â €â €
    â €â €â €â €â €â¢€â¡â €â €â ˆâ ³â£„â €â €â €â €â €â£€â ´â ‹â ‰â ‰â¡†â €â €â €â €â €
    â €â €â €â €â €â¢¸â €â €â €â €â €â ˆâ ‰â ‰â ™â “â šâ â €â €â €â €â£¿â €â €â €â €â €
    â €â €â €â €â¢€â â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ¹â£„â €â €â €â €
    â €â €â €â €â¡â €â €â €â €â €â ¶â €â €â €â €â €â €â ¦â €â €â €â €â €â ¸â¡†â €â €â €
    â¢ â£¤â£¶â£¾â£§â£¤â£¤â£€â¡€â €â €â €â €â ˆâ €â €â €â¢€â¡¤â ´â ¶â ¤â¢¤â¡€â£§â£€â£€â €
    â »â ¶â£¾â â €â €â €â €â ™â£†â €â €â €â €â €â €â£°â ‹â €â €â €â €â €â¢¹â£¿â£­â£½â ‡
    â €â €â ™â ¤â ´â¢¤â¡¤â ¤â ¤â ‹â ‰â ‰â ‰â ‰â ‰â ‰â ‰â ³â –â ¦â ¤â ¶â ¦â â â €â €â €
        </div>
        
        <a href="https://github.com/duri-wip" class="contact-link" target="_blank">
            <i class="fab fa-github"></i>
            <span>GitHub</span>
        </a>
        
        
        <a href="mailto:8s.eow.ooc@gmail.com" class="contact-link">
            <i class="fas fa-envelope"></i>
            <span>Email</span>
        </a>
        
    </div>
    
</aside>
        
        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <!-- í—¤ë” -->
            <header class="header">
    <nav>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/">home</a>
            </li>
            <li class="nav-item">
                <a href="/categories">category</a>
            </li>
            <li class="nav-item">
                <a href="/study">study</a>
            </li>
            <li class="nav-item">
                <a href="/projects">project</a>
            </li>
        </ul>
    </nav>
</header>
            
            <!-- ì½˜í…ì¸  ì˜ì—­ -->
            <div class="content">
                <article class="post">
    <header class="post-header">
        <h1 class="post-title">RAG ê³ ê¸‰ ê¸°ë²• ì™„ì „ ì •ë³µ</h1>
        <div class="post-meta">
            <time class="post-date">2025ë…„ 08ì›” 04ì¼</time>
            
            <div class="post-categories">
                
                    
                    <span class="category-tag">ML-AI</span>
                    
                
                    
                
                
                <span class="subcategory-tag">rag</span>
                
            </div>
            
            
            <div class="post-tags">
                
                <span class="tag">#genai-llm</span>
                
                <span class="tag">#langchain</span>
                
                <span class="tag">#rag</span>
                
                <span class="tag">#hyde</span>
                
                <span class="tag">#rerank</span>
                
                <span class="tag">#hybrid-search</span>
                
                <span class="tag">#study-llm-framework</span>
                
            </div>
            
        </div>
    </header>

    <div class="post-content">
        <h1 id="ragì—-ê´€í•œ-ë‹¤ì–‘í•œ-ê³ ê¸‰-ê¸°ë²•">RAGì— ê´€í•œ ë‹¤ì–‘í•œ ê³ ê¸‰ ê¸°ë²•</h1>

<h2 id="1-ê²€ìƒ‰-ì¿¼ë¦¬-ê´€ë ¨-ê¸°ë²•">1. ê²€ìƒ‰ ì¿¼ë¦¬ ê´€ë ¨ ê¸°ë²•</h2>

<h3 id="hyde-hypothetical-document-embeddings">HyDE (Hypothetical Document Embeddings)</h3>

<ul>
  <li><strong>ê°œë…</strong>: ì§ˆì˜ì— ëŒ€í•œ ê°€ìƒì˜ ë‹µë³€(ì»¨í…ìŠ¤íŠ¸ ì—†ì´) ìƒì„± â†’ ì´ ë‹µë³€ê³¼ ìœ ì‚¬í•œ ë¬¸ì„œ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±</li>
  <li><strong>ëª©ì </strong>: ê²€ìƒ‰ ì¿¼ë¦¬ì˜ í’ˆì§ˆ í–¥ìƒ</li>
</ul>

<h4 id="1-ì§ì ‘-êµ¬í˜„">1. ì§ì ‘ êµ¬í˜„</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hypothetical_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
    ë‹¤ìŒ ì§ˆë¬¸ì— í•œ ë¬¸ì¥ìœ¼ë¡œ ë‹µí•˜ì„¸ìš”.
    ì§ˆë¬¸ : {question}
    </span><span class="sh">"""</span><span class="p">)</span>

<span class="n">hypothetical_chain</span> <span class="o">=</span> <span class="n">hypothetical_prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>

<span class="n">hyde_rag_chain</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">hypothetical_chain</span> <span class="o">|</span> <span class="n">retriever</span><span class="p">,</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>

<span class="n">hyde_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainì˜ ê°œìš”ë¥¼ ì•Œë ¤ì¤˜</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="2-langchain-ëª¨ë“ˆ-í™œìš©">2. LangChain ëª¨ë“ˆ í™œìš©</h4>

<ul>
  <li><strong>HypotheticalDocumentEmbedder</strong> ì‚¬ìš©</li>
</ul>

<h3 id="multi-query-generation">Multi-Query Generation</h3>

<ul>
  <li><strong>ê°œë…</strong>: ë³µìˆ˜ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±ìœ¼ë¡œ ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ê²€ìƒ‰</li>
</ul>

<h4 id="1-ì§ì ‘-êµ¬í˜„-1">1. ì§ì ‘ êµ¬í˜„</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span> <span class="nc">QueryGenerate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">queries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(...,</span> <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">ê²€ìƒ‰ ì¿¼ë¦¬ ëª©ë¡</span><span class="sh">"</span><span class="p">)</span>

<span class="n">query_generate_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="se">\
</span><span class="s">    ì§ˆë¬¸ì— ëŒ€í•´ ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê´€ë ¨ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ê¸° ìœ„í•œ 3ê°œì˜ ì„œë¡œ ë‹¤ë¥¸ ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ì„¸ìš”.
    ê±°ë¦¬ ê¸°ë°˜ ìœ ì‚¬ì„± ê²€ìƒ‰ì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ ì—¬ëŸ¬ ê´€ì ì„ ì œê³µí•˜ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.

    ì§ˆë¬¸ : {question}
    </span><span class="sh">"""</span><span class="p">)</span>

<span class="n">query_generate_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">query_generate_prompt</span>
    <span class="o">|</span> <span class="n">model</span><span class="p">.</span><span class="nf">with_structured_output</span><span class="p">(</span><span class="n">QueryGenerate</span><span class="p">)</span>
    <span class="o">|</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="n">queries</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">multi_query_chain</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">query_generate_chain</span> <span class="o">|</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">map</span><span class="p">(),</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>

<span class="n">multi_query_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainì˜ ê°œìš”ë¥¼ ì•Œë ¤ì¤˜</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Note</strong>: <code class="language-plaintext highlighter-rouge">map</code>ì€ LangChain ëŸ¬ë„ˆë¸”ì´ ì œê³µí•˜ëŠ” ë©”ì„œë“œ ì¤‘ í•˜ë‚˜ë¡œ, ì›ë˜ ëŸ¬ë„ˆë¸”ì˜ ì¸ìì™€ ë°˜í™˜ê°’ì„ ë¦¬ìŠ¤íŠ¸í™”í•˜ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤.</p>

<h4 id="2-langchain-ëª¨ë“ˆ-í™œìš©-1">2. LangChain ëª¨ë“ˆ í™œìš©</h4>

<ul>
  <li><strong>MultiQueryRetriever</strong> ì‚¬ìš©</li>
</ul>

<h2 id="2-ê²€ìƒ‰-í›„-ê¸°ë²•-reciprocal-rank-fusion-rrf">2. ê²€ìƒ‰ í›„ ê¸°ë²•: Reciprocal Rank Fusion (RRF)</h2>

<p>ì—¬ëŸ¬ ê²€ìƒ‰ ê²°ê³¼ì˜ ìˆœìœ„ë¥¼ ìœµí•©í•´ ì •ë ¬í•˜ëŠ” ê¸°ë²•ì…ë‹ˆë‹¤.</p>

<h3 id="rag-fusion">RAG-Fusion</h3>

<ul>
  <li><strong>ê°œë…</strong>: ì—¬ëŸ¬ ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ê³  ì´ë¥¼ ê²°ê³¼ë¥¼ ì •ë ¬í•˜ê¸°</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_core.documents</span> <span class="kn">import</span> <span class="n">Document</span>

<span class="k">def</span> <span class="nf">reciprocal_rank_fusion</span><span class="p">(</span>
        <span class="n">retriever_outputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># ê° ë¬¸ì„œì˜ ì½˜í…ì¸ (ë¬¸ìì—´)ì™€ ê·¸ ì ìˆ˜ì˜ ë§¤í•‘ì„ ì €ì¥í•˜ëŠ” ë”•ì…”ë„ˆë¦¬ ì¤€ë¹„
</span>    <span class="n">content_score_mapping</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># ê²€ìƒ‰ ì¿¼ë¦¬ë§ˆë‹¤ ë°˜ë³µ
</span>    <span class="k">for</span> <span class="n">docs</span> <span class="ow">in</span> <span class="n">retriever_outputs</span><span class="p">:</span>
        <span class="c1"># ê²€ìƒ‰ ê²°ê³¼ì˜ ë¬¸ì„œë§ˆë‹¤ ë°˜ë³µ
</span>        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">docs</span><span class="p">):</span>
            <span class="c1"># ë¬¸ì„œì˜ ì½˜í…ì¸ ì™€ ì ìˆ˜ë¥¼ ë”•ì…”ë„ˆë¦¬ì— ì¶”ê°€
</span>            <span class="n">content</span> <span class="o">=</span> <span class="n">doc</span><span class="p">.</span><span class="n">page_content</span>

            <span class="k">if</span> <span class="n">content</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content_score_mapping</span><span class="p">:</span>
                <span class="n">content_score_mapping</span><span class="p">[</span><span class="n">content</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># ì ìˆ˜ ì—…ë°ì´íŠ¸
</span>            <span class="n">content_score_mapping</span><span class="p">[</span><span class="n">content</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

    <span class="c1"># ì ìˆ˜ì— ë”°ë¼ ì •ë ¬ëœ ë¬¸ì„œ ëª©ë¡ ë°˜í™˜
</span>    <span class="n">sorted_contents</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span>
        <span class="n">content_score_mapping</span><span class="p">.</span><span class="nf">items</span><span class="p">(),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">content</span> <span class="k">for</span> <span class="n">content</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sorted_contents</span><span class="p">]</span>

<span class="c1"># ì²´ì¸ êµ¬í˜„
</span><span class="n">rag_fusion_chain</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">query_generate_chain</span> <span class="o">|</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">map</span><span class="p">()</span> <span class="o">|</span> <span class="n">reciprocal_rank_fusion</span><span class="p">,</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>

<span class="n">rag_fusion_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainì˜ ê°œìš”ë¥¼ ì•Œë ¤ì¤˜</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="rerank">ReRank</h3>

<ul>
  <li><strong>ê°œë…</strong>: ì–´ë–¤ ê²€ìƒ‰ ì¿¼ë¦¬ì— ëŒ€í•œ ì—¬ëŸ¬ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì •ë ¬í•˜ê¸°</li>
  <li><strong>ì¥ì </strong>: ë¦¬ë­í¬ìš© ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ ì‚¬ìš©í•´ì„œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì •ë ¬. ì„ë² ë”© ë²¡í„°ì˜ ìœ ì‚¬ë„ ê²€ìƒ‰ë³´ë‹¤ ê³„ì‚°ë¹„ìš©ì´ ë†’ì€ ëŒ€ì‹  ë­í‚¹ ì •í™•ë„ê°€ ë†’ìŒ</li>
</ul>

<h4 id="1-cohere-ëª¨ë¸-ì‚¬ìš©">1. Cohere ëª¨ë¸ ì‚¬ìš©</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="n">langchain_cohere</span> <span class="kn">import</span> <span class="n">CohereRerank</span>
<span class="kn">from</span> <span class="n">langchain_core.documents</span> <span class="kn">import</span> <span class="n">Document</span>

<span class="k">def</span> <span class="nf">rerank</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="sh">"</span><span class="s">documents</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">cohere_reranker</span> <span class="o">=</span> <span class="nc">CohereRerank</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="sh">"</span><span class="s">rerank-multilingual-v3.0</span><span class="sh">"</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="n">top_n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cohere_reranker</span><span class="p">.</span><span class="nf">compress_documents</span><span class="p">(</span><span class="n">documents</span><span class="o">=</span><span class="n">documents</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>

<span class="n">rerank_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
        <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">retriever</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="o">|</span> <span class="n">RunnablePassthrough</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">rerank</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">prompt</span>
    <span class="o">|</span> <span class="n">model</span>
    <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">rerank_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainì˜ ê°œìš”ë¥¼ ì•Œë ¤ì¤˜</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Note</strong>: RunnablePassthrough assignì„ í†µí•´ {question, context}ì˜ ì¶œë ¥ì´ rerankí•¨ìˆ˜ì˜ ì¸ì inpì— ì „ë‹¬ë©ë‹ˆë‹¤.</p>

<h4 id="2-langchain-ëª¨ë“ˆ-í™œìš©-2">2. LangChain ëª¨ë“ˆ í™œìš©</h4>

<ul>
  <li><strong>ContextualCompressionRetriever</strong> ì‚¬ìš©</li>
</ul>

<h2 id="3-ë³µìˆ˜ì˜-ë¦¬íŠ¸ë¦¬ë²„ë¥¼-ì‚¬ìš©í•˜ëŠ”-ê¸°ë²•">3. ë³µìˆ˜ì˜ ë¦¬íŠ¸ë¦¬ë²„ë¥¼ ì‚¬ìš©í•˜ëŠ” ê¸°ë²•</h2>

<h3 id="ë¼ìš°íŠ¸ì—-ë”°ë¼-ë‹¤ë¥¸-ë¦¬íŠ¸ë¦¬ë²„-ì‚¬ìš©í•˜ê¸°">ë¼ìš°íŠ¸ì— ë”°ë¼ ë‹¤ë¥¸ ë¦¬íŠ¸ë¦¬ë²„ ì‚¬ìš©í•˜ê¸°</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_community.retrievers</span> <span class="kn">import</span> <span class="n">TavilySearchAPIRetriever</span>

<span class="c1"># LangSmithì—ì„œ ë” ì˜ í™•ì¸í•˜ê¸° ìœ„í•œ ì„¤ì •
</span><span class="n">langchain_document_retriever</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">with_config</span><span class="p">({</span><span class="sh">"</span><span class="s">run_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">langchain_document_retriever</span><span class="sh">"</span><span class="p">})</span>
<span class="n">web_retriever</span> <span class="o">=</span> <span class="nc">TavilySearchAPIRetriever</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">).</span><span class="nf">with_config</span><span class="p">({</span><span class="sh">"</span><span class="s">run_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">web_retriever</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># ì‚¬ìš©ì ì…ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ LLMì´ ë¦¬íŠ¸ë¦¬ë²„ë¥¼ ì„ íƒí•˜ëŠ” ì²´ì¸
</span><span class="kn">from</span> <span class="n">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">Route</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">langchain_document</span> <span class="o">=</span> <span class="sh">"</span><span class="s">langchain_document</span><span class="sh">"</span>
    <span class="n">web</span> <span class="o">=</span> <span class="sh">"</span><span class="s">web</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">RouteOutput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">route</span><span class="p">:</span> <span class="n">Route</span>

<span class="n">route_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
    ë‹¤ìŒ ì§ˆë¬¸ì— ëŒ€í•´ ì ì ˆí•œ ë¦¬íŠ¸ë¦¬ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”.
    ì§ˆë¬¸ : {question}
    </span><span class="sh">"""</span><span class="p">)</span>

<span class="n">route_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">route_prompt</span>
    <span class="o">|</span> <span class="n">model</span><span class="p">.</span><span class="nf">with_structured_output</span><span class="p">(</span><span class="n">RouteOutput</span><span class="p">)</span>
    <span class="o">|</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="n">route</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># ë¼ìš°íŒ… ê²°ê³¼ë¥¼ ê³ ë ¤í•´ ê²€ìƒ‰í•˜ëŠ” í•¨ìˆ˜ êµ¬í˜„
</span><span class="k">def</span> <span class="nf">routed_retriever</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">route</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="sh">"</span><span class="s">route</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">route</span> <span class="o">==</span> <span class="n">Route</span><span class="p">.</span><span class="n">langchain_document</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">langchain_document_retriever</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">route</span> <span class="o">==</span> <span class="n">Route</span><span class="p">.</span><span class="n">web</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">web_retriever</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>

    <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalid route: </span><span class="si">{</span><span class="n">route</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># ë¼ìš°íŠ¸ ì²´ì¸ê³¼ ë¼ìš°íŠ¸ ê²°ê³¼ë¥¼ ê³ ë ¤í•´ ê²€ìƒ‰í•˜ëŠ” ì²´ì¸
</span><span class="n">routed_retriever_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">{</span>
        <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
        <span class="sh">"</span><span class="s">route</span><span class="sh">"</span><span class="p">:</span> <span class="n">route_chain</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="o">|</span> <span class="n">RunnablePassthrough</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">routed_retriever</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">prompt</span>
    <span class="o">|</span> <span class="n">model</span>
    <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">routed_retriever_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainì˜ ê°œìš”ë¥¼ ì•Œë ¤ì¤˜</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="í•˜ì´ë¸Œë¦¬ë“œ-ê²€ìƒ‰">í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰</h3>

<p>RAGì˜ êµ¬í˜„ì—ì„œëŠ” ì„ë² ë”© ë²¡í„°ì˜ ìœ ì‚¬ë„ ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ëŠ”ë°, ë²”ìš©ì ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ì„ë² ë”© ëª¨ë¸ì—ì„œëŠ” í•™ìŠµë°ì´í„°ì— í¬í•¨ë˜ì§€ ì•Šì€ ê³ ìœ ëª…ì‚¬ë‚˜ ì „ë¬¸ìš©ì–´ì˜ ìœ ì‚¬ë„ ê³„ì‚°ì´ ì–´ë µìŠµë‹ˆë‹¤.</p>

<p>ìì—°ì–´ ì²˜ë¦¬ì˜ ê³ ì „ì ì¸ ê¸°ë²•ìœ¼ë¡œ ë‹¨ì–´ì˜ ë“±ì¥ ë¹ˆë„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í…ìŠ¤íŠ¸ì˜ ìœ ì‚¬ë„ë¥¼ ê³„ì‚°í•˜ëŠ” <strong>TF-IDF</strong>, <strong>BM25</strong>(TF-IDFì˜ ê°œì„ íŒ) ë“±ì´ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ëŸ° ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ë©´ ê³µí†µ ë‹¨ì–´ì˜ ë¹ˆë„ê°€ ë†’ìœ¼ë©´ ë²¡í„° ìœ ì‚¬ë„ê°€ ë†’ì•„ì§€ê¸° ë•Œë¬¸ì—, ë²”ìš© ì„ë² ë”© ëª¨ë¸ì˜ ë‹¨ì ì„ ë³´ì™„í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        ã€Œ ì„ë² ë”© ëª¨ë¸ì— ì˜í•œ ë²¡í„°í™”                  -- ë°€ì§‘ë²¡í„°(ëŒ€ë¶€ë¶„ ìš”ì†Œê°€ 0ì´ ì•„ë‹˜)
TEXT ---
         ã„´ TF-IDF ë˜ëŠ” BM25ë¥¼ ì‚¬ìš©í•œ ë²¡í„°í™”         -- í¬ì†Œë²¡í„°(0ì´ ë§ìŒ)
</code></pre></div></div>

<p>ë²¡í„° í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì¸ <strong>PINECONE</strong>ì—ì„œë„ ë°€ì§‘ ë²¡í„°ì™€ í¬ì†Œ ë²¡í„° ê²€ìƒ‰ì„ ì¡°í•©í•œ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>

<h4 id="1-í•˜ì´ë¸Œë¦¬ë“œ-ê²€ìƒ‰-êµ¬í˜„-bm25-ì‚¬ìš©">1. í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ êµ¬í˜„: BM25 ì‚¬ìš©</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>rank-bm25<span class="o">==</span>0.2.2
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_community.retrievers</span> <span class="kn">import</span> <span class="n">BM25Retriever</span>

<span class="n">chroma_retriever</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">with_config</span><span class="p">({</span><span class="sh">"</span><span class="s">run_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">chroma_retriever</span><span class="sh">"</span><span class="p">})</span>

<span class="n">bm25_retriever</span> <span class="o">=</span> <span class="n">BM25Retriever</span><span class="p">.</span><span class="nf">from_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">).</span><span class="nf">with_config</span><span class="p">({</span><span class="sh">"</span><span class="s">run_name</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">bm25_retriever</span><span class="sh">"</span><span class="p">})</span>

<span class="c1"># ë‘ ë¦¬íŠ¸ë¦¬ë²„ë¥¼ ì¡°í•©í•´ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ì²´ì¸ êµ¬í˜„
</span><span class="n">hybrid_retriever_chain</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nc">RunnableParallel</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">chroma_documents</span><span class="sh">"</span><span class="p">:</span> <span class="n">chroma_retriever</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">bm25_documents</span><span class="sh">"</span><span class="p">:</span> <span class="n">bm25_retriever</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="o">|</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">chroma_documents</span><span class="sh">"</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="sh">"</span><span class="s">bm25_documents</span><span class="sh">"</span><span class="p">]])</span>
    <span class="o">|</span> <span class="n">reciprocal_rank_fusion</span>
<span class="p">)</span>

<span class="c1"># ì „ì²´ RAG ì²´ì¸ êµ¬í˜„
</span><span class="n">rag_chain</span> <span class="o">=</span> <span class="p">({</span>
    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="nc">RunnablePassthrough</span><span class="p">(),</span>
    <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="n">hybrid_retriever_chain</span><span class="p">,</span>
<span class="p">}</span> <span class="o">|</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">model</span> <span class="o">|</span> <span class="nc">StrOutputParser</span><span class="p">())</span>

<span class="n">rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="sh">"</span><span class="s">langchainì˜ ê°œìš”ë¥¼ ì•Œë ¤ì¤˜</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="2-langchain-ëª¨ë“ˆ-í™œìš©-3">2. LangChain ëª¨ë“ˆ í™œìš©</h4>

<ul>
  <li><strong>EnsembleRetriever</strong> ì‚¬ìš©</li>
</ul>

<h2 id="-ì¶”ê°€ë¡œ-ì•Œì•„ë³¼-ë‚´ìš©">ğŸ“š ì¶”ê°€ë¡œ ì•Œì•„ë³¼ ë‚´ìš©</h2>

<h3 id="1-ìµœì‹ -rag-ê¸°ë²•ë“¤">1. ìµœì‹  RAG ê¸°ë²•ë“¤</h3>

<p><strong>Contextual Retrieval (ì»¨í…ìŠ¤íŠ¸ ë³´ê°• ê²€ìƒ‰):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_core.prompts</span> <span class="kn">import</span> <span class="n">ChatPromptTemplate</span>

<span class="c1"># ê° ì²­í¬ì— ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì¶”ê°€
</span><span class="n">context_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
ë‹¤ìŒ ë¬¸ì„œ ì²­í¬ì— ëŒ€í•´ ì „ì²´ ë¬¸ì„œì˜ ë§¥ë½ì„ ê³ ë ¤í•˜ì—¬
ê°„ë‹¨í•œ ë°°ê²½ ì„¤ëª…ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.

ì „ì²´ ë¬¸ì„œ ì£¼ì œ: {document_topic}
ì²­í¬ ë‚´ìš©: {chunk_content}

ë°°ê²½ ì„¤ëª…ì´ í¬í•¨ëœ ì²­í¬:
</span><span class="sh">"""</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_context_to_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">document_topic</span><span class="p">):</span>
    <span class="n">contextual_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="n">context_added</span> <span class="o">=</span> <span class="n">context_prompt</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
            <span class="n">document_topic</span><span class="o">=</span><span class="n">document_topic</span><span class="p">,</span>
            <span class="n">chunk_content</span><span class="o">=</span><span class="n">chunk</span><span class="p">.</span><span class="n">page_content</span>
        <span class="p">)</span>
        <span class="c1"># LLMìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€ëœ ì²­í¬ ìƒì„±
</span>        <span class="n">enhanced_chunk</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">context_added</span><span class="p">)</span>
        <span class="n">contextual_chunks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">enhanced_chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">contextual_chunks</span>
</code></pre></div></div>

<p><strong>Parent Document Retriever (ìƒìœ„ ë¬¸ì„œ ê²€ìƒ‰):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.retrievers</span> <span class="kn">import</span> <span class="n">ParentDocumentRetriever</span>
<span class="kn">from</span> <span class="n">langchain.storage</span> <span class="kn">import</span> <span class="n">InMemoryStore</span>

<span class="c1"># ì‘ì€ ì²­í¬ë¡œ ê²€ìƒ‰í•˜ì§€ë§Œ í° ì»¨í…ìŠ¤íŠ¸ ë°˜í™˜
</span><span class="n">parent_splitter</span> <span class="o">=</span> <span class="nc">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
<span class="n">child_splitter</span> <span class="o">=</span> <span class="nc">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

<span class="n">store</span> <span class="o">=</span> <span class="nc">InMemoryStore</span><span class="p">()</span>

<span class="n">retriever</span> <span class="o">=</span> <span class="nc">ParentDocumentRetriever</span><span class="p">(</span>
    <span class="n">vectorstore</span><span class="o">=</span><span class="n">vectorstore</span><span class="p">,</span>
    <span class="n">docstore</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
    <span class="n">child_splitter</span><span class="o">=</span><span class="n">child_splitter</span><span class="p">,</span>
    <span class="n">parent_splitter</span><span class="o">=</span><span class="n">parent_splitter</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p><strong>Multi-Vector Retriever (ë‹¤ì¤‘ ë²¡í„° ê²€ìƒ‰):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.retrievers.multi_vector</span> <span class="kn">import</span> <span class="n">MultiVectorRetriever</span>

<span class="c1"># í•˜ë‚˜ì˜ ë¬¸ì„œì— ëŒ€í•´ ì—¬ëŸ¬ í‘œí˜„ ë°©ì‹ ìƒì„±
</span><span class="k">def</span> <span class="nf">create_multi_representations</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">summary</span><span class="sh">"</span><span class="p">:</span> <span class="n">summarize_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">keywords</span><span class="sh">"</span><span class="p">:</span> <span class="n">keyword_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">questions</span><span class="sh">"</span><span class="p">:</span> <span class="n">question_gen_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="n">doc</span><span class="p">),</span>
        <span class="sh">"</span><span class="s">original</span><span class="sh">"</span><span class="p">:</span> <span class="n">doc</span><span class="p">.</span><span class="n">page_content</span>
    <span class="p">}</span>

<span class="n">multi_retriever</span> <span class="o">=</span> <span class="nc">MultiVectorRetriever</span><span class="p">(</span>
    <span class="n">vectorstore</span><span class="o">=</span><span class="n">vectorstore</span><span class="p">,</span>
    <span class="n">docstore</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
    <span class="n">id_key</span><span class="o">=</span><span class="sh">"</span><span class="s">doc_id</span><span class="sh">"</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="2-ê³ ê¸‰-í‰ê°€-ë°-ìµœì í™”">2. ê³ ê¸‰ í‰ê°€ ë° ìµœì í™”</h3>

<p><strong>A/B Testing for RAG:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RAGVariant</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">retriever</span><span class="p">:</span> <span class="nb">any</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">RAGExperiment</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">variants</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RAGVariant</span><span class="p">]):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">variants</span> <span class="o">=</span> <span class="n">variants</span>
        <span class="n">self</span><span class="p">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">run_experiment</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">test_questions</span><span class="p">,</span> <span class="n">sample_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">test_questions</span><span class="p">:</span>
            <span class="c1"># ëœë¤í•˜ê²Œ variant ì„ íƒ
</span>            <span class="n">variant</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">variants</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">sample_ratio</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">evaluate_variant</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="n">question</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">"</span><span class="s">variant</span><span class="sh">"</span><span class="p">:</span> <span class="n">variant</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">:</span> <span class="n">result</span>
                <span class="p">})</span>

    <span class="k">def</span> <span class="nf">evaluate_variant</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">variant</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
        <span class="c1"># ì‹¤ì œ í‰ê°€ ë¡œì§
</span>        <span class="n">context</span> <span class="o">=</span> <span class="n">variant</span><span class="p">.</span><span class="n">retriever</span><span class="p">.</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">variant</span><span class="p">.</span><span class="n">prompt</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">answer</span><span class="sh">"</span><span class="p">:</span> <span class="n">answer</span><span class="p">,</span> <span class="sh">"</span><span class="s">context_count</span><span class="sh">"</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">context</span><span class="p">)}</span>
</code></pre></div></div>

<p><strong>Dynamic Retrieval Optimization:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AdaptiveRetriever</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">retrievers</span><span class="p">,</span> <span class="n">performance_tracker</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">retrievers</span> <span class="o">=</span> <span class="n">retrievers</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tracker</span> <span class="o">=</span> <span class="n">performance_tracker</span>
        <span class="n">self</span><span class="p">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">retrievers</span><span class="p">.</span><span class="nf">keys</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># ì„±ëŠ¥ ê¸°ë°˜ìœ¼ë¡œ retriever ì„ íƒ
</span>        <span class="n">best_retriever</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">select_best_retriever</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">retrievers</span><span class="p">[</span><span class="n">best_retriever</span><span class="p">].</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># ê²°ê³¼ í’ˆì§ˆ í”¼ë“œë°± ìˆ˜ì§‘
</span>        <span class="n">self</span><span class="p">.</span><span class="n">tracker</span><span class="p">.</span><span class="nf">record_retrieval</span><span class="p">(</span><span class="n">best_retriever</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span>

    <span class="k">def</span> <span class="nf">select_best_retriever</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># ì¿¼ë¦¬ ìœ í˜• ë¶„ì„í•´ì„œ ìµœì  retriever ì„ íƒ
</span>        <span class="n">query_type</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">classify_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">retrievers</span><span class="p">.</span><span class="nf">keys</span><span class="p">(),</span>
                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">weights</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_type_affinity</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">query_type</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="3-ê³ ê¸‰-í”„ë¡¬í”„íŠ¸-ì—”ì§€ë‹ˆì–´ë§">3. ê³ ê¸‰ í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§</h3>

<p><strong>Self-RAG (ìê¸° ë°˜ì„± RAG):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self_rag_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
ì§ˆë¬¸: {question}
ê²€ìƒ‰ëœ ì •ë³´: {context}

1ë‹¨ê³„: ê²€ìƒ‰ëœ ì •ë³´ê°€ ì§ˆë¬¸ì— ê´€ë ¨ì´ ìˆëŠ”ì§€ í‰ê°€í•˜ì„¸ìš”.
ê´€ë ¨ì„± ì ìˆ˜: [1-10]

2ë‹¨ê³„: ê´€ë ¨ì„±ì´ 7ì  ì´ìƒì´ë©´ ë‹µë³€ì„ ìƒì„±í•˜ê³ ,
ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ </span><span class="sh">"</span><span class="s">ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤</span><span class="sh">"</span><span class="s">ë¼ê³  ì‘ë‹µí•˜ì„¸ìš”.

3ë‹¨ê³„: ìƒì„±í•œ ë‹µë³€ì´ ê²€ìƒ‰ëœ ì •ë³´ì— ê¸°ë°˜í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
ê·¼ê±°: [ê²€ìƒ‰ ì •ë³´ì—ì„œ ì¸ìš©]

ìµœì¢… ë‹µë³€:
</span><span class="sh">"""</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">self_rag_chain</span><span class="p">(</span><span class="n">question</span><span class="p">):</span>
    <span class="c1"># 1ì°¨ ê²€ìƒ‰
</span>    <span class="n">initial_docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>

    <span class="c1"># ìê¸° í‰ê°€
</span>    <span class="n">evaluation</span> <span class="o">=</span> <span class="n">self_rag_prompt</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="nf">format_docs</span><span class="p">(</span><span class="n">initial_docs</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="c1"># ì¶”ê°€ ê²€ìƒ‰ í•„ìš”ì‹œ
</span>    <span class="k">if</span> <span class="sh">"</span><span class="s">ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">evaluation</span><span class="p">:</span>
        <span class="c1"># ì¿¼ë¦¬ í™•ì¥ ë˜ëŠ” ë‹¤ë¥¸ ê²€ìƒ‰ ì „ëµ ì‹œë„
</span>        <span class="n">expanded_query</span> <span class="o">=</span> <span class="nf">expand_query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="n">additional_docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">expanded_query</span><span class="p">)</span>
        <span class="c1"># ì¬ì‹œë„
</span>        <span class="k">return</span> <span class="n">self_rag_prompt</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">context</span><span class="sh">"</span><span class="p">:</span> <span class="nf">format_docs</span><span class="p">(</span><span class="n">initial_docs</span> <span class="o">+</span> <span class="n">additional_docs</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">evaluation</span>
</code></pre></div></div>

<h3 id="4-ê³ ê¸‰-ê²€ìƒ‰-ê¸°ë²•">4. ê³ ê¸‰ ê²€ìƒ‰ ê¸°ë²•</h3>

<p><strong>Iterative Retrieval (ë°˜ë³µ ê²€ìƒ‰):</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">iterative_retrieval</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">all_docs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_question</span> <span class="o">=</span> <span class="n">question</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="c1"># í˜„ì¬ ì§ˆë¬¸ìœ¼ë¡œ ê²€ìƒ‰
</span>        <span class="n">docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="p">.</span><span class="nf">get_relevant_documents</span><span class="p">(</span><span class="n">current_question</span><span class="p">)</span>
        <span class="n">all_docs</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>

        <span class="c1"># ê²€ìƒ‰ ê²°ê³¼ë¡œ í›„ì† ì§ˆë¬¸ ìƒì„±
</span>        <span class="n">follow_up_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_template</span><span class="p">(</span><span class="sh">"""</span><span class="s">
        ì›ë³¸ ì§ˆë¬¸: {original_question}
        ê²€ìƒ‰ ê²°ê³¼: {search_results}

        ì´ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì›ë³¸ ì§ˆë¬¸ì— ë” ì™„ì „íˆ ë‹µí•˜ê¸° ìœ„í•´
        ì¶”ê°€ë¡œ í•„ìš”í•œ ì •ë³´ë¥¼ ì°¾ê¸° ìœ„í•œ ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ì„¸ìš”.

        ì¶”ê°€ ê²€ìƒ‰ ì¿¼ë¦¬:
        </span><span class="sh">"""</span><span class="p">)</span>

        <span class="n">follow_up</span> <span class="o">=</span> <span class="n">follow_up_prompt</span><span class="p">.</span><span class="nf">invoke</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">original_question</span><span class="sh">"</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">search_results</span><span class="sh">"</span><span class="p">:</span> <span class="nf">format_docs</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
        <span class="p">})</span>

        <span class="n">current_question</span> <span class="o">=</span> <span class="n">follow_up</span>

        <span class="c1"># ì¶©ë¶„í•œ ì •ë³´ ìˆ˜ì§‘ í™•ì¸
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_sufficient_information</span><span class="p">(</span><span class="n">all_docs</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">all_docs</span>
</code></pre></div></div>

<h2 id="-í•™ìŠµí•˜ë©´ì„œ-ì•Œê²Œ-ëœ-ì ">ğŸ” í•™ìŠµí•˜ë©´ì„œ ì•Œê²Œ ëœ ì </h2>

<h3 id="1-hydeì˜-ì‹¤ì œ-íš¨ê³¼ì™€-í•œê³„">1. HyDEì˜ ì‹¤ì œ íš¨ê³¼ì™€ í•œê³„</h3>

<p><strong>íš¨ê³¼ê°€ ì¢‹ì€ ê²½ìš°:</strong></p>

<ul>
  <li>ì „ë¬¸ ë„ë©”ì¸ ì§ˆë¬¸ (ì˜ë£Œ, ë²•ë¥ , ê¸°ìˆ )</li>
  <li>ì¶”ìƒì  ê°œë…ì— ëŒ€í•œ ì§ˆë¬¸</li>
  <li>ì‚¬ìš©ì ì§ˆë¬¸ì´ ëª¨í˜¸í•œ ê²½ìš°</li>
</ul>

<p><strong>íš¨ê³¼ê°€ ì œí•œì ì¸ ê²½ìš°:</strong></p>

<ul>
  <li>ì‚¬ì‹¤ í™•ì¸ ì§ˆë¬¸</li>
  <li>ë§¤ìš° êµ¬ì²´ì ì¸ ë°ì´í„° ê²€ìƒ‰</li>
  <li>ì‹¤ì‹œê°„ ì •ë³´ê°€ í•„ìš”í•œ ê²½ìš°</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">should_use_hyde</span><span class="p">(</span><span class="n">question</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">HyDE ì‚¬ìš© ì—¬ë¶€ ê²°ì •</span><span class="sh">"""</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ì¶”ìƒì </span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">ì›ë¦¬</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ê°œë…</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì´ìœ </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ë°©ë²•</span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">ì „ë¬¸ì </span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">ê¸°ìˆ </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì˜ë£Œ</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ë²•ë¥ </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">í•™ìˆ </span><span class="sh">"</span><span class="p">],</span>
        <span class="sh">"</span><span class="s">ë¶ˆëª…í™•</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">?</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì–´ë–»ê²Œ</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì™œ</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ì„¤ëª…</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">keywords</span> <span class="ow">in</span> <span class="n">indicators</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">question</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">category</span>

    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">êµ¬ì²´ì _ì‚¬ì‹¤_ì§ˆë¬¸</span><span class="sh">"</span>
</code></pre></div></div>

<h3 id="2-ë©€í‹°-ì¿¼ë¦¬ì˜-ìµœì -ê°œìˆ˜">2. ë©€í‹° ì¿¼ë¦¬ì˜ ìµœì  ê°œìˆ˜</h3>

<p>ì‹¤í—˜ ê²°ê³¼, <strong>3-5ê°œì˜ ì¿¼ë¦¬</strong>ê°€ ìµœì :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">optimal_multi_query_count</span><span class="p">(</span><span class="n">question_complexity</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">question_complexity</span> <span class="o">==</span> <span class="sh">"</span><span class="s">simple</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># ì›ë³¸ + 1ê°œ ë³€í˜•
</span>    <span class="k">elif</span> <span class="n">question_complexity</span> <span class="o">==</span> <span class="sh">"</span><span class="s">medium</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>  <span class="c1"># ì›ë³¸ + 2ê°œ ë³€í˜•
</span>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># complex
</span>        <span class="k">return</span> <span class="mi">5</span>  <span class="c1"># ì›ë³¸ + 4ê°œ ë³€í˜•
</span></code></pre></div></div>

<h3 id="3-rrf-íŒŒë¼ë¯¸í„°-kì˜-ì‹¤ì œ-ì˜í–¥">3. RRF íŒŒë¼ë¯¸í„° kì˜ ì‹¤ì œ ì˜í–¥</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">analyze_rrf_k_impact</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">RRF k ê°’ì´ ê²°ê³¼ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ë¶„ì„</span><span class="sh">"""</span>
    <span class="n">k_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ìƒìœ„ê¶Œ ë¬¸ì„œ ê°€ì¤‘ì¹˜: </span><span class="si">{</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">k</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">í•˜ìœ„ê¶Œ ë¬¸ì„œ ê°€ì¤‘ì¹˜ (rank=10): </span><span class="si">{</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">k</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>ê²°ê³¼:</strong></p>

<ul>
  <li>k=1: ìˆœìœ„ ì°¨ì´ ê·¹ëŒ€í™” (ìƒìœ„ ë¬¸ì„œ ì••ë„ì  ìš°ìœ„)</li>
  <li>k=60: ê· í˜•ì¡íŒ ê°€ì¤‘ì¹˜ (ê¸°ë³¸ê°’)</li>
  <li>k=100: ìˆœìœ„ ì°¨ì´ ìµœì†Œí™” (ëª¨ë“  ë¬¸ì„œ ë¹„ìŠ·í•œ ê°€ì¤‘ì¹˜)</li>
</ul>

<h3 id="4-í•˜ì´ë¸Œë¦¬ë“œ-ê²€ìƒ‰ì˜-ìµœì -ë¹„ìœ¨">4. í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ì˜ ìµœì  ë¹„ìœ¨</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">find_optimal_hybrid_ratio</span><span class="p">(</span><span class="n">dense_retriever</span><span class="p">,</span> <span class="n">sparse_retriever</span><span class="p">,</span> <span class="n">test_queries</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ë°€ì§‘/í¬ì†Œ ê²€ìƒ‰ì˜ ìµœì  ê²°í•© ë¹„ìœ¨ íƒìƒ‰</span><span class="sh">"""</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>  <span class="c1"># ë°€ì§‘ ë²¡í„° ë¹„ìœ¨
</span>
    <span class="n">best_ratio</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">ratios</span><span class="p">:</span>
        <span class="c1"># ê° ë¹„ìœ¨ë¡œ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ìˆ˜í–‰
</span>        <span class="n">hybrid_retriever</span> <span class="o">=</span> <span class="nc">EnsembleRetriever</span><span class="p">(</span>
            <span class="n">retrievers</span><span class="o">=</span><span class="p">[</span><span class="n">dense_retriever</span><span class="p">,</span> <span class="n">sparse_retriever</span><span class="p">],</span>
            <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">ratio</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">ratio</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># í‰ê°€ ì ìˆ˜ ê³„ì‚°
</span>        <span class="n">score</span> <span class="o">=</span> <span class="nf">evaluate_retriever</span><span class="p">(</span><span class="n">hybrid_retriever</span><span class="p">,</span> <span class="n">test_queries</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
            <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">ratio</span>

    <span class="k">return</span> <span class="n">best_ratio</span>
</code></pre></div></div>

<p><strong>ì¼ë°˜ì ì¸ ê²½í—˜ê°’:</strong></p>

<ul>
  <li>ê¸°ìˆ  ë¬¸ì„œ: ë°€ì§‘ 70% + í¬ì†Œ 30%</li>
  <li>ë‰´ìŠ¤/ì¼ë°˜: ë°€ì§‘ 50% + í¬ì†Œ 50%</li>
  <li>FAQ: ë°€ì§‘ 40% + í¬ì†Œ 60%</li>
</ul>

<h3 id="5-rerank-ëª¨ë¸ì˜-ì„ íƒ-ê¸°ì¤€">5. ReRank ëª¨ë¸ì˜ ì„ íƒ ê¸°ì¤€</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rerank_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">cohere-rerank-multilingual-v3.0</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ì–¸ì–´</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë‹¤êµ­ì–´ (í•œêµ­ì–´ í¬í•¨)</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ì„±ëŠ¥</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë†’ìŒ</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ë¹„ìš©</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë†’ìŒ</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ìš©ë„</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">í”„ë¡œë•ì…˜</span><span class="sh">"</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">bge-reranker-large</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ì–¸ì–´</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì˜ì–´ ì¤‘ì‹¬</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ì„±ëŠ¥</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì¤‘ê°„</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ë¹„ìš©</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë¬´ë£Œ</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ìš©ë„</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì‹¤í—˜/í”„ë¡œí† íƒ€ì…</span><span class="sh">"</span>
    <span class="p">},</span>
    <span class="sh">"</span><span class="s">sentence-transformers/ms-marco-MiniLM-L-12-v2</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ì–¸ì–´</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì˜ì–´</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ì„±ëŠ¥</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì¤‘ê°„</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ë¹„ìš©</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë¬´ë£Œ</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ìš©ë„</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ë¹ ë¥¸ í”„ë¡œí† íƒ€ì…</span><span class="sh">"</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="6-ì‹¤ì œ-í”„ë¡œë•ì…˜ì—ì„œì˜-ì„±ëŠ¥-ìµœì í™”-ê²½í—˜">6. ì‹¤ì œ í”„ë¡œë•ì…˜ì—ì„œì˜ ì„±ëŠ¥ ìµœì í™” ê²½í—˜</h3>

<p><strong>ì²­í‚¹ ì „ëµ ìµœì í™”:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">adaptive_chunking</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ë¬¸ì„œ ìœ í˜•ì— ë”°ë¥¸ ì ì‘ì  ì²­í‚¹</span><span class="sh">"""</span>
    <span class="n">strategies</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="se">\n\n</span><span class="s">class </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n\n</span><span class="s">def </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">]},</span>
        <span class="sh">"</span><span class="s">legal</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span> <span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\</span><span class="s">n</span><span class="se">\\</span><span class="s">d+</span><span class="se">\\</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">. </span><span class="sh">"</span><span class="p">]},</span>
        <span class="sh">"</span><span class="s">technical</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="s">### </span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="s">- </span><span class="sh">"</span><span class="p">]}</span>
    <span class="p">}</span>

    <span class="n">strategy</span> <span class="o">=</span> <span class="n">strategies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">. </span><span class="sh">"</span><span class="p">]})</span>

    <span class="n">splitter</span> <span class="o">=</span> <span class="nc">RecursiveCharacterTextSplitter</span><span class="p">(</span>
        <span class="n">chunk_size</span><span class="o">=</span><span class="n">strategy</span><span class="p">[</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">],</span>
        <span class="n">chunk_overlap</span><span class="o">=</span><span class="nf">int</span><span class="p">(</span><span class="n">strategy</span><span class="p">[</span><span class="sh">"</span><span class="s">chunk_size</span><span class="sh">"</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span>  <span class="c1"># 10% ê²¹ì¹¨
</span>        <span class="n">separators</span><span class="o">=</span><span class="n">strategy</span><span class="p">[</span><span class="sh">"</span><span class="s">separators</span><span class="sh">"</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">splitter</span><span class="p">.</span><span class="nf">split_documents</span><span class="p">([</span><span class="n">document</span><span class="p">])</span>
</code></pre></div></div>

<p><strong>ë²¡í„° DB ì„±ëŠ¥ ìµœì í™”:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">optimize_vector_db</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">ë²¡í„° DB ì„±ëŠ¥ ìµœì í™” íŒ</span><span class="sh">"""</span>
    <span class="n">tips</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">ì¸ë±ìŠ¤_êµ¬ì„±</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">HNSW &gt; IVF &gt; Flat (ì„±ëŠ¥ vs ì •í™•ë„)</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ë°°ì¹˜_í¬ê¸°</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì„ë² ë”©ì‹œ 100-1000ê°œ ë‹¨ìœ„ë¡œ ë°°ì¹˜ ì²˜ë¦¬</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ë©”ëª¨ë¦¬_ê´€ë¦¬</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ì£¼ê¸°ì  ì¸ë±ìŠ¤ ì••ì¶• ë° ì •ë¦¬</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ì¿¼ë¦¬_ìµœì í™”</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">top_këŠ” 20 ì´í•˜ë¡œ ì œí•œ</span><span class="sh">"</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">tips</span>
</code></pre></div></div>

<p>ì´ëŸ¬í•œ ê³ ê¸‰ ê¸°ë²•ë“¤ê³¼ ì‹¤ì „ ê²½í—˜ì„ í†µí•´ ë”ìš± íš¨ê³¼ì ì¸ RAG ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    </div>

    <footer class="post-footer">
        <div class="post-nav">
            
            <a class="prev-post" href="/ml-ai/evaluation/">
                <span class="nav-label">ì´ì „ ê¸€</span>
                <span class="nav-title">RAG ì‹œìŠ¤í…œ í‰ê°€í•˜ê¸°</span>
            </a>
            
            
            
            <a class="next-post" href="/ml-ai/prompt-engineering/">
                <span class="nav-label">ë‹¤ìŒ ê¸€</span>
                <span class="nav-title">í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ ì™„ì „ ì •ë³µ</span>
            </a>
            
        </div>
        
        <div class="back-to-home">
            <a href="/">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </footer>
</article>
            </div>
        </main>
    </div>
</body>
</html>